<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå¡ç‰‡åˆ¶ä½œå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 15px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .api-config {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            position: relative;
        }

        .api-status {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
            z-index: 100;
        }

        .api-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .api-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .api-status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .api-config input {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .api-config input:focus {
            outline: none;
            border-color: #667eea;
        }

        .api-config button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .api-config button:hover {
            background: #5a67d8;
        }

        .param-selector {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .param-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .param-group {
            flex: 1;
            min-width: 200px;
        }

        .param-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .param-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s;
        }

        .param-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .content-input {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .content-input h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            min-height: 600px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .panel h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #5a6268;
        }

        .btn.success {
            background: #28a745;
        }

        .btn.success:hover {
            background: #218838;
        }

        .btn.danger {
            background: #dc3545;
        }

        .btn.danger:hover {
            background: #c82333;
        }

        .preview-area {
            flex: 1;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            text-align: center;
            color: #6c757d;
            position: relative;
        }

        .preview-area.has-content {
            border-color: #28a745;
            background: white;
        }

        .preview-controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .prompt-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .prompt-display {
            flex: 1;
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 400px;
        }

        .prompt-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .template-selector {
            margin-bottom: 15px;
        }

        .template-selector select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .status-bar {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: none;
        }

        .status-bar.show {
            display: block;
        }

        .status-bar.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-bar.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-bar.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .loading {
            position: relative;
            opacity: 0.7;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            margin: -20px 0 0 -20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .advanced-mode {
            margin-top: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 8px;
            display: none;
        }

        .advanced-mode.show {
            display: block;
        }

        .advanced-mode textarea {
            width: 100%;
            height: 200px;
            padding: 12px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
        }

        .color-theme {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .color-theme:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .color-theme.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .color-theme.fresh {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .color-theme.business {
            background: linear-gradient(45deg, #3498db, #2c3e50);
        }

        .color-theme.warm {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .color-theme.tech {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
        }

        .theme-name {
            color: white;
            font-weight: 600;
            text-align: center;
            font-size: 14px;
        }

        .png-options-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .option-group {
            margin-bottom: 20px;
        }

        .option-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .option-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .param-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .param-section .param-group {
            margin-bottom: 15px;
        }

        .param-section .param-group:last-child {
            margin-bottom: 0;
        }

        .custom-templates {
            margin-bottom: 20px;
        }

        .custom-templates h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
        }

        .template-list {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .template-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e9ecef;
        }

        .template-item:hover {
            background: #e9ecef;
        }

        .template-name {
            font-weight: 500;
            color: #333;
            cursor: pointer;
        }

        .template-actions {
            display: flex;
            gap: 5px;
        }

        .template-actions button {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .template-actions .load-btn {
            background: #667eea;
            color: white;
        }

        .template-actions .delete-btn {
            background: #dc3545;
            color: white;
        }

        .content-section {
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
            border-radius: 15px;
            border: 2px solid #c1d3ff;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }
        
        .content-section:hover {
            border-color: #667eea;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.15);
        }
        
        .content-section label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #4a5568;
            font-size: 16px;
        }

        .input-with-button {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .input-with-button textarea {
            flex: 1;
            min-height: 80px;
            resize: vertical;
            font-size: 18px;
            line-height: 1.5;
            border: 2px solid #d1d9e6;
            border-radius: 12px;
            padding: 15px;
            background: white;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .input-with-button textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .apply-btn {
            padding: 10px 20px;
            font-size: 14px;
            white-space: nowrap;
            margin-top: 0;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .input-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .param-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .param-group {
                min-width: 100%;
            }
            
            .api-config {
                flex-direction: column;
            }
            
            .api-config input {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨é…ç½®åŒº -->
        <div class="header">
            <h1>ğŸ¨ AIå¡ç‰‡åˆ¶ä½œå™¨</h1>
            <div style="text-align: center; margin: 10px 0; padding: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-size: 14px;">
                ğŸ“± å…³æ³¨å…¬ä¼—å·ï¼š<strong>æ™¨æ˜æ•…äºº</strong> è·å–æ›´å¤šAIå®ç”¨ç©æ³•
            </div>
            <div class="api-config">
                <input type="password" id="apiKey" placeholder="è¯·è¾“å…¥ DeepSeek API Key">
                <button onclick="saveApiKey()">ä¿å­˜</button>
                <button onclick="testApiKey()" id="testApiBtn">æµ‹è¯•è¿æ¥</button>
                <div class="api-status" id="apiStatus"></div>
            </div>
        </div>


        <!-- ä¸»è¦å·¥ä½œåŒº -->
        <div class="main-content">
            <!-- å·¦æ ï¼šé¢„è§ˆåŒºåŸŸ -->
            <div class="panel">
                <h2>ğŸ–¼ï¸ é¢„è§ˆæ•ˆæœ</h2>
                <div class="preview-area" id="previewArea">
                    <div>
                        <p>ğŸ¨ å¡ç‰‡é¢„è§ˆåŒºåŸŸ</p>
                        <p>é€‰æ‹©å‚æ•°å¹¶å¡«å†™å†…å®¹åç‚¹å‡»ç”Ÿæˆ</p>
                    </div>
                </div>
                <div class="preview-controls">
                    <button class="btn" onclick="generateCard()" id="generateBtn" disabled>
                        âœ¨ ç”Ÿæˆå¡ç‰‡
                    </button>
                    <button class="btn secondary" onclick="downloadSVG()" id="downloadSVGBtn" disabled>
                        ğŸ“„ ä¸‹è½½ SVG
                    </button>
                    <button class="btn success" onclick="showPNGOptions()" id="downloadPNGBtn" disabled>
                        ğŸ–¼ï¸ ä¸‹è½½ PNG
                    </button>
                    <button class="btn secondary" onclick="copyToClipboard()" id="copyBtn" disabled>
                        ğŸ“‹ å¤åˆ¶ä»£ç 
                    </button>
                </div>
                
                <!-- PNGé€‰é¡¹å¼¹çª— -->
                <div class="png-options-modal" id="pngOptionsModal" style="display: none;">
                    <div class="modal-content">
                        <h3>PNG å¯¼å‡ºé€‰é¡¹</h3>
                        <div class="option-group">
                            <label>ç¼©æ”¾å€æ•°</label>
                            <select id="pngScale">
                                <option value="1">1x (æ ‡å‡†)</option>
                                <option value="2" selected>2x (é«˜æ¸…)</option>
                                <option value="3">3x (è¶…é«˜æ¸…)</option>
                                <option value="4">4x (4K)</option>
                            </select>
                        </div>
                        <div class="option-group">
                            <label>èƒŒæ™¯è‰²</label>
                            <select id="pngBackground">
                                <option value="transparent">é€æ˜</option>
                                <option value="white" selected>ç™½è‰²</option>
                                <option value="black">é»‘è‰²</option>
                            </select>
                        </div>
                        <div class="modal-buttons">
                            <button class="btn" onclick="downloadPNGWithOptions()">ä¸‹è½½ PNG</button>
                            <button class="btn secondary" onclick="closePNGOptions()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- å³æ ï¼šæç¤ºè¯ç®¡ç† -->
            <div class="panel">
                <h2>âš™ï¸ æç¤ºè¯ç®¡ç†</h2>
                
                <!-- ä¸»ä½“å†…å®¹è¾“å…¥åŒº -->
                <div class="content-section">
                    <div class="param-group">
                        <label for="mainContent">ä¸»ä½“å†…å®¹</label>
                        <div class="input-with-button">
                            <textarea id="mainContent" placeholder="è¾“å…¥ä¸»ä½“å†…å®¹ï¼ˆå¦‚ï¼šå•è¯ã€ç”µå½±åã€ä¹¦åç­‰ï¼‰"></textarea>
                            <button class="btn apply-btn" onclick="applyMainContent()">åº”ç”¨</button>
                        </div>
                    </div>
                </div>
                
                <!-- å‚æ•°é€‰æ‹©åŒº -->
                <div class="param-section">
                    <div class="param-group">
                        <label for="cardType">å¡ç‰‡ç±»å‹</label>
                        <select id="cardType" onchange="onParameterChange()">
                            <option value="word">å•è¯å­¦ä¹ å¡ç‰‡</option>
                            <option value="book">è¯»ä¹¦ç¬”è®°å¡ç‰‡</option>
                            <option value="movie">ç”µå½±æ”¶è—å¡ç‰‡</option>
                            <option value="custom">è‡ªå®šä¹‰å¡ç‰‡</option>
                        </select>
                    </div>
                    <div class="param-group">
                        <label for="dimensions">å¡ç‰‡å°ºå¯¸</label>
                        <select id="dimensions" onchange="onParameterChange()">
                            <option value="800x500">800x500 (æ¨ªç‰ˆ)</option>
                            <option value="500x800">500x800 (ç«–ç‰ˆ)</option>
                            <option value="600x600">600x600 (æ­£æ–¹å½¢)</option>
                            <option value="400x400">400x400 (å°æ­£æ–¹å½¢)</option>
                            <option value="1000x600">1000x600 (å®½å±)</option>
                        </select>
                    </div>
                    <div class="param-group">
                        <label for="styleTheme">é£æ ¼ä¸»é¢˜</label>
                        <select id="styleTheme" onchange="onParameterChange()">
                            <option value="fresh">ğŸŒ¿ æ¸…æ–°é£æ ¼</option>
                            <option value="business">ğŸ’¼ å•†åŠ¡é£æ ¼</option>
                            <option value="warm">ğŸŒ… æ¸©æš–é£æ ¼</option>
                            <option value="tech">ğŸš€ ç§‘æŠ€é£æ ¼</option>
                        </select>
                    </div>
                </div>
                
                <!-- è‡ªå®šä¹‰æ¨¡æ¿ç®¡ç† -->
                <div class="custom-templates">
                    <h3>æ¨¡æ¿ç®¡ç†</h3>
                    <div class="template-list" id="customTemplateList">
                        <!-- åŠ¨æ€ç”Ÿæˆçš„æ¨¡æ¿åˆ—è¡¨ -->
                    </div>
                    <button class="btn secondary" onclick="saveCurrentAsTemplate()">
                        ğŸ’¾ ä¿å­˜å½“å‰é…ç½®
                    </button>
                    <button class="btn secondary" onclick="resetToDefaultTemplate()" style="margin-top: 10px;">
                        ğŸ”„ é‡ç½®ä¸ºé»˜è®¤æ¨¡æ¿
                    </button>
                </div>
                
                <!-- æç¤ºè¯ç¼–è¾‘å™¨ -->
                <div class="prompt-editor">
                    <div class="prompt-display" id="promptDisplay">
                        å½“å‰æç¤ºè¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º...
                    </div>
                    <div class="prompt-controls">
                        <button class="btn secondary" onclick="toggleAdvancedMode()">
                            ğŸ”§ é«˜çº§ç¼–è¾‘
                        </button>
                        <button class="btn secondary" onclick="exportTemplate()">
                            ğŸ“¤ å¯¼å‡ºæ¨¡æ¿
                        </button>
                    </div>
                    <div class="advanced-mode" id="advancedMode">
                        <textarea id="promptEditor" placeholder="åœ¨æ­¤ç¼–è¾‘æç¤ºè¯..."></textarea>
                        <button class="btn" onclick="applyCustomPrompt()">åº”ç”¨è‡ªå®šä¹‰æç¤ºè¯</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- çŠ¶æ€æ  -->
        <div class="status-bar" id="statusBar">
            <span id="statusText"></span>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentSVG = '';
        let currentPrompt = '';
        let templates = {};
        let userSettings = {};

        // å¸¦è¶…æ—¶çš„fetchå‡½æ•°
        async function fetchWithTimeout(url, options = {}, timeout = 60000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·å°è¯•ç®€åŒ–æç¤ºè¯æˆ–ç¨åé‡è¯•');
                }
                throw error;
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadUserSettings();
            initializeTemplates();
            loadCustomTemplates();
            updatePromptTemplate();
            updateCustomTemplateList();
        });

        // æœ¬åœ°å­˜å‚¨ç®¡ç†
        function loadUserSettings() {
            const saved = localStorage.getItem('aiCardMaker_settings');
            if (saved) {
                userSettings = JSON.parse(saved);
                if (userSettings.apiKey) {
                    document.getElementById('apiKey').value = userSettings.apiKey;
                    document.getElementById('generateBtn').disabled = false;
                }
            }
        }

        function saveUserSettings() {
            localStorage.setItem('aiCardMaker_settings', JSON.stringify(userSettings));
        }

        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (apiKey) {
                userSettings.apiKey = apiKey;
                saveUserSettings();
                document.getElementById('generateBtn').disabled = false;
                showStatus('API Key å·²ä¿å­˜', 'success');
            } else {
                showStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„ API Key', 'error');
            }
        }

        async function testApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const apiStatus = document.getElementById('apiStatus');
            const testBtn = document.getElementById('testApiBtn');
            
            if (!apiKey) {
                showApiStatus('è¯·å…ˆè¾“å…¥ API Key', 'error');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            testBtn.disabled = true;
            testBtn.textContent = 'æµ‹è¯•ä¸­...';
            showApiStatus('æ­£åœ¨æµ‹è¯• API è¿æ¥...', 'loading');

            try {
                const response = await fetchWithTimeout('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            { role: 'user', content: 'æµ‹è¯•è¿æ¥' }
                        ],
                        max_tokens: 10
                    })
                }, 30000); // 30ç§’è¶…æ—¶

                if (response.ok) {
                    showApiStatus('âœ… API è¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
                    userSettings.apiKey = apiKey;
                    saveUserSettings();
                    document.getElementById('generateBtn').disabled = false;
                    
                    // 3ç§’åéšè—æˆåŠŸæ¶ˆæ¯
                    setTimeout(() => {
                        apiStatus.style.display = 'none';
                    }, 3000);
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showApiStatus(`âŒ API è¿æ¥å¤±è´¥: ${errorData.error?.message || 'è¯·æ£€æŸ¥ API Key'}`, 'error');
                }
            } catch (error) {
                showApiStatus(`âŒ ç½‘ç»œè¿æ¥å¤±è´¥: ${error.message}`, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'æµ‹è¯•è¿æ¥';
            }
        }

        function showApiStatus(message, type) {
            const apiStatus = document.getElementById('apiStatus');
            apiStatus.textContent = message;
            apiStatus.className = `api-status ${type}`;
            apiStatus.style.display = 'block';
        }

        // åˆå§‹åŒ–æ¨¡æ¿
        function initializeTemplates() {
            templates = {
                'word-800x500-fresh': {
                    name: 'å•è¯å¡ç‰‡-æ¨ªç‰ˆ-æ¸…æ–°é£æ ¼',
                    type: 'word',
                    dimensions: '800x500',
                    style: 'fresh',
                    prompt: `è¯·åˆ¶ä½œä¸€å¼ å•è¯å­¦ä¹ å¡ç‰‡ï¼Œè¦æ±‚ï¼š

## å¡ç‰‡è§„æ ¼
- å°ºå¯¸ï¼š800x500px
- é£æ ¼ï¼šæ¸…æ–°è‡ªç„¶ï¼Œç»¿è‰²ç³»é…è‰²
- æ ¼å¼ï¼šå®Œæ•´çš„SVGä»£ç 

## è®¾è®¡è¦æ±‚
- ä½¿ç”¨æ¸…æ–°çš„ç»¿è‰²ç³»é…è‰²ï¼ˆ#27ae60, #2ecc71, #a8e6cfï¼‰
- å­—ä½“æ¸…æ™°æ˜“è¯»ï¼Œå±‚æ¬¡åˆ†æ˜
- é€‚å½“çš„è£…é¥°å…ƒç´ ï¼Œä½“ç°å­¦ä¹ ä¸»é¢˜
- æ‰€æœ‰æ–‡å­—å¿…é¡»åœ¨å®‰å…¨åŒºåŸŸå†…
- æ ¹æ®ä¸»ä½“å†…å®¹è‡ªåŠ¨è¡¥å……ç›¸å…³ä¿¡æ¯ï¼ˆå¦‚éŸ³æ ‡ã€é‡Šä¹‰ã€ä¾‹å¥ç­‰ï¼‰

ç›´æ¥è¿”å›å®Œæ•´çš„SVGä»£ç ï¼Œæ— éœ€å…¶ä»–è¯´æ˜ã€‚`,
                    variables: []
                },
                'book-600x600-warm': {
                    name: 'è¯»ä¹¦ç¬”è®°-æ­£æ–¹å½¢-æ¸©æš–é£æ ¼',
                    type: 'book',
                    dimensions: '600x600',
                    style: 'warm',
                    prompt: `è¯·åˆ¶ä½œä¸€å¼ è¯»ä¹¦ç¬”è®°å¡ç‰‡ï¼Œè¦æ±‚ï¼š

## å¡ç‰‡è§„æ ¼
- å°ºå¯¸ï¼š600x600px
- é£æ ¼ï¼šæ¸©æš–æ–‡è‰ºï¼Œæ©™é»„è‰²ç³»
- æ ¼å¼ï¼šå®Œæ•´çš„SVGä»£ç 

## è®¾è®¡è¦æ±‚
- ä½¿ç”¨æ¸©æš–çš„æ©™é»„è‰²ç³»é…è‰²ï¼ˆ#f39c12, #e67e22, #ffd89bï¼‰
- è¥é€ çº¸å¼ è´¨æ„Ÿï¼Œä½“ç°è¯»ä¹¦æ°›å›´
- é€‚å½“çš„è£…é¥°å…ƒç´ ï¼ˆä¹¦ç±ã€ç¾½æ¯›ç¬”ç­‰ï¼‰
- æ–‡å­—æ’ç‰ˆä¼˜é›…ï¼Œæ˜“äºé˜…è¯»
- æ ¹æ®ä¸»ä½“å†…å®¹è‡ªåŠ¨è¡¥å……ç›¸å…³ä¿¡æ¯ï¼ˆå¦‚ä½œè€…ã€ä¸»é¢˜ã€é‡‘å¥ç­‰ï¼‰

ç›´æ¥è¿”å›å®Œæ•´çš„SVGä»£ç ï¼Œæ— éœ€å…¶ä»–è¯´æ˜ã€‚`,
                    variables: []
                },
                'movie-800x500-tech': {
                    name: 'ç”µå½±æ”¶è—-æ¨ªç‰ˆ-ç§‘æŠ€é£æ ¼',
                    type: 'movie',
                    dimensions: '800x500',
                    style: 'tech',
                    prompt: `è¯·åˆ¶ä½œä¸€å¼ ç”µå½±æ”¶è—å¡ç‰‡ï¼Œè¦æ±‚ï¼š

## å¡ç‰‡è§„æ ¼
- å°ºå¯¸ï¼š800x500px
- é£æ ¼ï¼šç°ä»£ç§‘æŠ€ï¼Œè“ç´«è‰²ç³»
- æ ¼å¼ï¼šå®Œæ•´çš„SVGä»£ç 

## è®¾è®¡è¦æ±‚
- ä½¿ç”¨ç°ä»£ç§‘æŠ€æ„Ÿçš„è“ç´«è‰²ç³»é…è‰²ï¼ˆ#3498db, #9b59b6, #667eeaï¼‰
- ç®€æ´ç°ä»£çš„è®¾è®¡é£æ ¼
- é€‚å½“çš„å‡ ä½•è£…é¥°å…ƒç´ 
- çªå‡ºç”µå½±ä¸»é¢˜çš„è§†è§‰æ•ˆæœ
- æ ¹æ®ä¸»ä½“å†…å®¹è‡ªåŠ¨è¡¥å……ç›¸å…³ä¿¡æ¯ï¼ˆå¦‚å¯¼æ¼”ã€å¹´ä»½ã€å°è¯ç­‰ï¼‰

ç›´æ¥è¿”å›å®Œæ•´çš„SVGä»£ç ï¼Œæ— éœ€å…¶ä»–è¯´æ˜ã€‚`,
                    variables: []
                },
                'custom-400x600-simple': {
                    name: 'è‡ªå®šä¹‰å¡ç‰‡-ç«–ç‰ˆ-ç®€çº¦é£æ ¼',
                    type: 'custom',
                    dimensions: '400x600',
                    style: 'simple',
                    prompt: `è¯·åˆ¶ä½œä¸€å¼ è‡ªå®šä¹‰å¡ç‰‡ï¼Œè¦æ±‚ï¼š

## å¡ç‰‡è§„æ ¼
- å°ºå¯¸ï¼š400x600px
- é£æ ¼ï¼šç®€çº¦ç°ä»£
- æ ¼å¼ï¼šå®Œæ•´çš„SVGä»£ç 

## è®¾è®¡è¦æ±‚
- æ ¹æ®å†…å®¹é€‰æ‹©åˆé€‚çš„é…è‰²æ–¹æ¡ˆ
- å¸ƒå±€æ¸…æ™°ï¼Œå±‚æ¬¡åˆ†æ˜
- é€‚å½“çš„è£…é¥°å…ƒç´ ï¼Œä¸å–§å®¾å¤ºä¸»
- ç¡®ä¿æ‰€æœ‰æ–‡å­—æ¸…æ™°å¯è¯»

ç›´æ¥è¿”å›å®Œæ•´çš„SVGä»£ç ï¼Œæ— éœ€å…¶ä»–è¯´æ˜ã€‚`,
                    variables: []
                },
                
                // é¢„è®¾ä¼˜è´¨æ¨¡æ¿
                'preset-word-advanced': {
                    name: 'ğŸ“ è‹±è¯­å•è¯å­¦ä¹ å¡ç‰‡ï¼ˆé«˜çº§ç‰ˆï¼‰',
                    type: 'word',
                    dimensions: '800x1000',
                    style: 'educational',
                    prompt: `# è‹±è¯­å•è¯å­¦ä¹ å¡ç‰‡ SVG ç”Ÿæˆæ¨¡æ¿

## å¡ç‰‡è§„æ ¼
- **å°ºå¯¸**: 800px Ã— 1000px
- **èƒŒæ™¯**: ç™½è‰² (#FFFFFF)
- **è¾¹æ¡†**: 2px å®çº¿ï¼Œåœ†è§’ 12px
- **å­—ä½“**: Arial, sans-serif
- **é…è‰²æ–¹æ¡ˆ**:
  - æ ‡é¢˜è‰²: #2C3E50
  - é‡ç‚¹è‰²: #E74C3C
  - æ¬¡è¦è‰²: #3498DB
  - æ–‡æœ¬è‰²: #34495E
  - èƒŒæ™¯è‰²: #ECF0F1

## SVG ç»“æ„æ¨¡æ¿

\`\`\`svg
<svg width="800" height="1000" xmlns="http://www.w3.org/2000/svg">
  <!-- èƒŒæ™¯å’Œè¾¹æ¡† -->
  <rect x="2" y="2" width="796" height="996" rx="12" fill="#FFFFFF" stroke="#2C3E50" stroke-width="2"/>
  
  <!-- æ ‡é¢˜åŒºåŸŸ (y: 20-100) -->
  <rect x="20" y="20" width="760" height="80" rx="8" fill="#2C3E50"/>
  <text x="400" y="65" text-anchor="middle" font-size="36" font-weight="bold" fill="#FFFFFF">[å•è¯]</text>
  <text x="400" y="90" text-anchor="middle" font-size="20" fill="#FFFFFF">[éŸ³æ ‡] Â· [è¯æ€§ç¼©å†™]</text>
  
  <!-- é¢‘ç‡æ ‡è®° (y: 110-130) -->
  <text x="40" y="125" font-size="16" fill="#34495E">[é¢‘ç‡ç­‰çº§] [ä½¿ç”¨åœºæ™¯]</text>
  
  <!-- åˆ†éš”çº¿ -->
  <line x1="40" y1="140" x2="760" y2="140" stroke="#ECF0F1" stroke-width="2"/>
  
  <!-- å¿«é€Ÿç†è§£åŒº (y: 150-280) -->
  <text x="40" y="170" font-size="20" font-weight="bold" fill="#2C3E50">å¿«é€Ÿç†è§£</text>
  <rect x="40" y="180" width="720" height="90" rx="6" fill="#ECF0F1"/>
  <text x="60" y="210" font-size="18" fill="#E74C3C">æ„è¯: [è¯æ ¹]Â·[è¯ç¼€]</text>
  <text x="60" y="235" font-size="16" fill="#34495E">æ ¸å¿ƒå«ä¹‰: [æ ¸å¿ƒå«ä¹‰]</text>
  <text x="60" y="260" font-size="16" fill="#34495E">æœ€ç»ˆè§£é‡Š: [æœ€ç»ˆè§£é‡Š]</text>
  
  <!-- åˆ†éš”çº¿ -->
  <line x1="40" y1="290" x2="760" y2="290" stroke="#ECF0F1" stroke-width="2"/>
  
  <!-- è¯æ ¹ä»·å€¼åŒº (y: 300-480) -->
  <text x="40" y="320" font-size="20" font-weight="bold" fill="#2C3E50">è¯æ ¹ä»·å€¼</text>
  <rect x="40" y="330" width="350" height="140" rx="6" fill="#F8F9FA"/>
  <text x="60" y="355" font-size="18" fill="#3498DB">è¯æ ¹: [è¯æ ¹]</text>
  <text x="60" y="380" font-size="16" fill="#34495E">å«ä¹‰: [åŸºæœ¬å«ä¹‰]</text>
  <text x="60" y="405" font-size="16" fill="#34495E">é¢‘ç‡: [è¯æ ¹é¢‘ç‡ç­‰çº§]</text>
  <!-- è¯æ ¹å®¶æ—ç¤ºä¾‹ -->
  <text x="60" y="435" font-size="14" fill="#34495E">[å®¶æ—è¯1] - [å«ä¹‰1]</text>
  <text x="60" y="455" font-size="14" fill="#34495E">[å®¶æ—è¯2] - [å«ä¹‰2]</text>
  
  <!-- è¯ç¼€ä»·å€¼åŒº (y: 300-480, å³ä¾§) -->
  <rect x="410" y="330" width="350" height="140" rx="6" fill="#F8F9FA"/>
  <text x="430" y="355" font-size="18" fill="#3498DB">è¯ç¼€: [è¯ç¼€]</text>
  <text x="430" y="380" font-size="16" fill="#34495E">è§„å¾‹: [å˜åŒ–è§„å¾‹]</text>
  <text x="430" y="405" font-size="16" fill="#34495E">é¢‘ç‡: [è¯ç¼€é¢‘ç‡ç­‰çº§]</text>
  <!-- è¯ç¼€æ­é…ç¤ºä¾‹ -->
  <text x="430" y="435" font-size="14" fill="#34495E">[ä¾‹è¯1] - [å«ä¹‰1]</text>
  <text x="430" y="455" font-size="14" fill="#34495E">[ä¾‹è¯2] - [å«ä¹‰2]</text>
  
  <!-- åˆ†éš”çº¿ -->
  <line x1="40" y1="490" x2="760" y2="490" stroke="#ECF0F1" stroke-width="2"/>
  
  <!-- å®ç”¨æ­é…åŒº (y: 500-720) -->
  <text x="40" y="520" font-size="20" font-weight="bold" fill="#2C3E50">å®ç”¨æ­é…</text>
  <!-- æ­é…ç¤ºä¾‹ -->
  <rect x="40" y="530" width="720" height="80" rx="6" fill="#FFF5F5"/>
  <text x="60" y="555" font-size="16" font-weight="bold" fill="#E74C3C">å¸¸ç”¨æ­é…</text>
  <text x="60" y="580" font-size="14" fill="#34495E">[æ­é…1] - [é‡Šä¹‰1] ([åœºæ™¯1])</text>
  <text x="60" y="600" font-size="14" fill="#34495E">[æ­é…2] - [é‡Šä¹‰2] ([åœºæ™¯2])</text>
  
  <!-- è®°å¿†æŠ€å·§åŒº (y: 620-720) -->
  <rect x="40" y="620" width="350" height="90" rx="6" fill="#F0F8FF"/>
  <text x="60" y="645" font-size="16" font-weight="bold" fill="#3498DB">è®°å¿†æŠ€å·§</text>
  <text x="60" y="670" font-size="14" fill="#34495E">[æŠ€å·§1]</text>
  <text x="60" y="690" font-size="14" fill="#34495E">[æŠ€å·§2]</text>
  
  <!-- æ˜“æ··ç‚¹æç¤ºåŒº (y: 620-720, å³ä¾§) -->
  <rect x="410" y="620" width="350" height="90" rx="6" fill="#FFF8F0"/>
  <text x="430" y="645" font-size="16" font-weight="bold" fill="#F39C12">æ˜“æ··ç‚¹æç¤º</text>
  <text x="430" y="670" font-size="14" fill="#34495E">[æ˜“æ··è¯]: [åŒºåˆ†æ–¹æ³•]</text>
  <text x="430" y="690" font-size="14" fill="#34495E">[æç¤ºè¯´æ˜]</text>
  
  <!-- åˆ†éš”çº¿ -->
  <line x1="40" y1="730" x2="760" y2="730" stroke="#ECF0F1" stroke-width="2"/>
  
  <!-- åº•éƒ¨æ€»ç»“åŒº (y: 740-980) -->
  <rect x="40" y="740" width="720" height="220" rx="8" fill="#2C3E50"/>
  <text x="400" y="770" text-anchor="middle" font-size="18" font-weight="bold" fill="#FFFFFF">è®°å¿†è¦ç‚¹</text>
  <!-- å…³é”®ä¿¡æ¯æ±‡æ€» -->
  <text x="60" y="800" font-size="16" fill="#FFFFFF">â€¢ è¯æ ¹ [è¯æ ¹] = [å«ä¹‰] (æ´¾ç”Ÿè¯[æ•°é‡]+)</text>
  <text x="60" y="825" font-size="16" fill="#FFFFFF">â€¢ è¯ç¼€ [è¯ç¼€] = [è§„å¾‹] (ä½¿ç”¨ç‡[æ’å])</text>
  <text x="60" y="850" font-size="16" fill="#FFFFFF">â€¢ æ ¸å¿ƒè®°å¿†: [æœ€ç®€è®°å¿†æ³•]</text>
  <text x="60" y="875" font-size="16" fill="#FFFFFF">â€¢ ä½¿ç”¨åœºæ™¯: [ä¸»è¦åœºæ™¯]</text>
  <!-- ç›¸å…³è¯æ±‡ç½‘ç»œ -->
  <text x="60" y="910" font-size="14" fill="#ECF0F1">ç›¸å…³è¯æ±‡: [è¯1], [è¯2], [è¯3]</text>
  <text x="60" y="935" font-size="14" fill="#ECF0F1">è¿‘ä¹‰è¯ç»„: [è¿‘ä¹‰è¯1], [è¿‘ä¹‰è¯2]</text>
</svg>
\`\`\`

## ä½¿ç”¨è¯´æ˜

### é¢‘ç‡ç­‰çº§æ ‡è®°
- ğŸ”´ æé«˜é¢‘ï¼šæ•™è‚²éƒ¨è€ƒçº²æ ¸å¿ƒè¯æ±‡å‰3000
- ğŸ”µ é«˜é¢‘ï¼šæ•™è‚²éƒ¨è€ƒçº²æ ¸å¿ƒè¯æ±‡3000-5000  
- âšªï¸ ä¸­é¢‘ï¼šæ•™è‚²éƒ¨è€ƒçº²æ ¸å¿ƒè¯æ±‡5000-8000

### è¯æ ¹é¢‘ç‡ç­‰çº§
- ğŸ”´ æ´¾ç”Ÿè¯100+
- ğŸ”µ æ´¾ç”Ÿè¯50-100
- âšªï¸ æ´¾ç”Ÿè¯20-50

### è¯ç¼€é¢‘ç‡ç­‰çº§
- ğŸ”´ ä½¿ç”¨ç‡top20
- ğŸ”µ ä½¿ç”¨ç‡20-50
- âšªï¸ ä½¿ç”¨ç‡50å

### ä½¿ç”¨åœºæ™¯æ ‡è®°
- è€ƒè¯•å¸¸ç”¨ï¼šå„ç±»è¯­è¨€è€ƒè¯•é«˜é¢‘è¯
- å­¦æœ¯å¸¸ç”¨ï¼šå­¦æœ¯è®ºæ–‡å¸¸è§ç”¨è¯
- å•†åŠ¡å¸¸ç”¨ï¼šå•†ä¸šç¯å¢ƒå¸¸ç”¨è¯
- æ—¥å¸¸å¸¸ç”¨ï¼šæ—¥å¸¸äº¤æµé«˜é¢‘è¯
- ä¸“ä¸šé¢†åŸŸå¸¸ç”¨ï¼šç‰¹å®šä¸“ä¸šåœºæ™¯ç”¨è¯

## ç”Ÿæˆè¦æ±‚

1. **å›ºå®šå¸ƒå±€**ï¼šä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°åæ ‡å’Œå°ºå¯¸ç”Ÿæˆå„åŒºåŸŸ
2. **é¢œè‰²ç»Ÿä¸€**ï¼šä½¿ç”¨æŒ‡å®šçš„é…è‰²æ–¹æ¡ˆï¼Œç¡®ä¿è§†è§‰ä¸€è‡´æ€§
3. **å­—ä½“è§„èŒƒ**ï¼š
   - æ ‡é¢˜ï¼š36px/20px
   - å°æ ‡é¢˜ï¼š20px
   - æ­£æ–‡ï¼š16px/14px
4. **å†…å®¹ç²¾ç®€**ï¼šæ¯ä¸ªåŒºåŸŸçš„æ–‡æœ¬è¦ç®€æ´æ˜äº†ï¼Œé¿å…è¿‡é•¿
5. **é‡ç‚¹çªå‡º**ï¼šä½¿ç”¨é¢œè‰²å’Œå­—é‡åŒºåˆ†é‡è¦ä¿¡æ¯
6. **ç•™ç™½é€‚å½“**ï¼šä¿æŒå…ƒç´ é—´è·ï¼Œé¿å…æ‹¥æŒ¤

## ç¤ºä¾‹è¯·æ±‚æ ¼å¼

"è¯·ä½¿ç”¨ä¸Šè¿°SVGæ¨¡æ¿ä¸ºå•è¯ [å•è¯] ç”Ÿæˆå­¦ä¹ å¡ç‰‡ï¼Œé‡ç‚¹å…³æ³¨[ç‰¹å®šéœ€æ±‚ï¼Œå¦‚ï¼šè¯æ ¹è®°å¿†/æ˜“æ··è¯è¾¨æ/ä½¿ç”¨åœºæ™¯ç­‰]"`,
                    variables: [],
                    source: 'preset',
                    author: 'system'
                },
                
                'preset-movie-cinematic': {
                    name: 'ğŸ¬ ç”µå½±æ”¶è—å¡ç‰‡ï¼ˆç”µå½±çº§ï¼‰',
                    type: 'movie',
                    dimensions: '600x400',
                    style: 'cinematic',
                    prompt: `# ç”µå½±å¡ç‰‡åˆ¶ä½œæç¤ºè¯ v2.0

## è§’è‰²å®šä¹‰
ä½ æ˜¯ä¸€ä½ç²¾é€šSVGæŠ€æœ¯å’Œè§†è§‰è®¾è®¡çš„ç”µå½±æµ·æŠ¥è®¾è®¡å¸ˆï¼Œä¸“æ³¨äºåˆ›ä½œç²¾ç¾çš„æ¨ªå‘ç”µå½±æ”¶è—å¡ç‰‡ã€‚ä½ æ·±çŸ¥SVGæ–‡æœ¬å¸ƒå±€çš„æŠ€æœ¯ç»†èŠ‚ï¼Œèƒ½å¤Ÿç²¾ç¡®æ§åˆ¶æ–‡å­—ä½ç½®å’Œå¤§å°ï¼Œé¿å…ä»»ä½•è§†è§‰é—®é¢˜ã€‚

## æ ¸å¿ƒä»»åŠ¡

### 1. ä¿¡æ¯æ”¶é›†ä¸æ•´ç†
- **å¿…éœ€ä¿¡æ¯**ï¼šç‰‡åï¼ˆåŸè¯­è¨€+è‹±æ–‡+ä¸­æ–‡ï¼‰ã€å¯¼æ¼”ã€å¹´ä»½ã€ç‰‡é•¿ã€ç±»å‹
- **æ ¸å¿ƒå†…å®¹**ï¼šç²¾ç‚¼çš„ä¸€å¥è¯å‰§æƒ…ã€ä¸»é¢˜ç²¾ç¥
- **ç»å…¸å…ƒç´ **ï¼š1-2å¥ç»å…¸å°è¯ï¼ˆåŸè¯­è¨€ç‰ˆæœ¬ä¼˜å…ˆï¼‰ã€å…³é”®è§†è§‰ç¬¦å·
- **è¯„åˆ†æ•°æ®**ï¼šIMDbè¯„åˆ†ã€è±†ç“£è¯„åˆ†
- **è¯­è¨€å¤„ç†**ï¼šæ ¹æ®ç”µå½±æ¥æºå›½è‡ªåŠ¨è°ƒæ•´æ˜¾ç¤ºè¯­è¨€

### 2. SVGæŠ€æœ¯è§„èŒƒ
- **ç”»å¸ƒå°ºå¯¸**ï¼š600Ã—400pxï¼ˆå›ºå®šæ¯”ä¾‹ï¼‰
- **å®‰å…¨è¾¹è·**ï¼šå››å‘¨å„ç•™20pxè¾¹è·
- **æ–‡å­—é˜²æº¢å‡º**ï¼šæ‰€æœ‰æ–‡æœ¬å¿…é¡»è®¾ç½®åˆç†çš„æœ€å¤§å®½åº¦
- **å±‚çº§ç®¡ç†**ï¼šä½¿ç”¨SVGåˆ†ç»„ç¡®ä¿å…ƒç´ ä¸é‡å 

### 3. æ–‡å­—å¸ƒå±€è§„åˆ™

#### é˜²æ­¢æ–‡å­—é—®é¢˜çš„å…³é”®æªæ–½ï¼š
\`\`\`xml
<!-- æ–‡å­—å®‰å…¨è§„åˆ™ -->
1. æ‰€æœ‰æ–‡æœ¬ä½¿ç”¨ text-anchor ç²¾ç¡®å®šä½
2. é•¿æ–‡æœ¬å¿…é¡»åˆ†è¡Œæ˜¾ç¤ºï¼Œä½¿ç”¨ <tspan> å…ƒç´ 
3. è®¾ç½®åˆç†çš„ font-sizeï¼Œç¡®ä¿å¯è¯»æ€§
4. ä¸ºæ¯ä¸ªæ–‡æœ¬åŒºåŸŸé¢„ç•™è¶³å¤Ÿç©ºé—´
5. ä½¿ç”¨ dominant-baseline æ§åˆ¶å‚ç›´å¯¹é½
\`\`\`

#### æ–‡å­—å¤§å°è§„èŒƒï¼š
- **ç‰‡å**ï¼š24-28pxï¼ˆæ ¹æ®é•¿åº¦è°ƒæ•´ï¼‰
- **è‹±æ–‡å**ï¼š16-18px
- **ç»å…¸å°è¯**ï¼š14-16pxï¼ˆå¿…é¡»åˆ†è¡Œï¼‰
- **åŸºç¡€ä¿¡æ¯**ï¼š12-14px
- **æœ€å°å­—å·**ï¼šä¸å°äº10px

## å¤šè¯­è¨€æ˜¾ç¤ºè§„åˆ™

### ç”µå½±æ¥æºåœ°åŒºåˆ¤æ–­
1. **æ¬§ç¾ç”µå½±**ï¼ˆç¾å›½ã€è‹±å›½ã€æ³•å›½ã€å¾·å›½ã€æ„å¤§åˆ©ç­‰ï¼‰
   - ç¬¬ä¸€è¡Œï¼šè‹±æ–‡åŸå
   - ç¬¬äºŒè¡Œï¼šä¸­æ–‡è¯‘å
   - å°è¯ï¼šè‹±æ–‡åŸæ–‡ + ä¸­æ–‡ç¿»è¯‘

2. **æ—¥æœ¬ç”µå½±**
   - ç¬¬ä¸€è¡Œï¼šæ—¥æ–‡åŸåï¼ˆå‡å+æ±‰å­—ï¼‰
   - ç¬¬äºŒè¡Œï¼šè‹±æ–‡å / ç½—é©¬éŸ³
   - ç¬¬ä¸‰è¡Œï¼šä¸­æ–‡è¯‘åï¼ˆè¾ƒå°å­—å·ï¼‰
   - å°è¯ï¼šæ—¥æ–‡åŸæ–‡ + ä¸­æ–‡ç¿»è¯‘

3. **éŸ©å›½ç”µå½±**
   - ç¬¬ä¸€è¡Œï¼šéŸ©æ–‡åŸå
   - ç¬¬äºŒè¡Œï¼šè‹±æ–‡å / ç½—é©¬éŸ³
   - ç¬¬ä¸‰è¡Œï¼šä¸­æ–‡è¯‘åï¼ˆè¾ƒå°å­—å·ï¼‰
   - å°è¯ï¼šéŸ©æ–‡åŸæ–‡ + ä¸­æ–‡ç¿»è¯‘

4. **åè¯­ç”µå½±**ï¼ˆä¸­å›½å¤§é™†ã€é¦™æ¸¯ã€å°æ¹¾ï¼‰
   - ç¬¬ä¸€è¡Œï¼šä¸­æ–‡å
   - ç¬¬äºŒè¡Œï¼šè‹±æ–‡å
   - å°è¯ï¼šä¸­æ–‡åŸæ–‡

## SVGä»£ç æ¨¡æ¿

\`\`\`xml
<svg width="600" height="400" viewBox="0 0 600 400">
  <!-- å®šä¹‰æ¸å˜å’Œæ»¤é•œ -->
  <defs>
    <linearGradient id="bgGradient">
      <!-- æ¸å˜è‰²å½© -->
    </linearGradient>
    
    <!-- æ–‡å­—é˜´å½±æ»¤é•œ -->
    <filter id="textShadow">
      <feDropShadow dx="1" dy="1" stdDeviation="1" flood-opacity="0.3"/>
    </filter>
  </defs>
  
  <!-- èƒŒæ™¯å±‚ -->
  <rect width="600" height="400" fill="url(#bgGradient)"/>
  
  <!-- æ ‡é¢˜åŒºåŸŸ (y: 20-100) -->
  <g id="header">
    <!-- åŸè¯­è¨€æ ‡é¢˜ -->
    <text x="300" y="45" text-anchor="middle" 
          font-size="24" font-weight="bold" fill="#fff"
          font-family="'Noto Sans', Arial Unicode MS">
      <tspan>åŸè¯­è¨€æ ‡é¢˜</tspan>
    </text>
    
    <!-- è‹±æ–‡/ç½—é©¬éŸ³æ ‡é¢˜ -->
    <text x="300" y="70" text-anchor="middle" 
          font-size="16" fill="#fff" opacity="0.9">
      <tspan>English Title / Romanization</tspan>
    </text>
    
    <!-- ä¸­æ–‡æ ‡é¢˜ï¼ˆå¦‚éœ€è¦ï¼‰ -->
    <text x="300" y="90" text-anchor="middle" 
          font-size="14" fill="#fff" opacity="0.7">
      <tspan>ä¸­æ–‡è¯‘å (å¹´ä»½)</tspan>
    </text>
  </g>
  
  <!-- å¼•è¨€åŒºåŸŸ (y: 120-250) -->
  <g id="quote">
    <!-- åŸè¯­è¨€å°è¯ -->
    <text x="300" y="150" text-anchor="middle" 
          font-size="16" fill="#fff" font-style="italic"
          font-family="'Noto Sans', Arial Unicode MS">
      <tspan x="300" dy="0">åŸè¯­è¨€å°è¯ç¬¬ä¸€è¡Œ</tspan>
      <tspan x="300" dy="25">åŸè¯­è¨€å°è¯ç¬¬äºŒè¡Œ</tspan>
    </text>
    
    <!-- ä¸­æ–‡ç¿»è¯‘ -->
    <text x="300" y="210" text-anchor="middle" 
          font-size="14" fill="#fff" opacity="0.85">
      <tspan x="300" dy="0">ã€Œä¸­æ–‡ç¿»è¯‘ç¬¬ä¸€è¡Œ</tspan>
      <tspan x="300" dy="22">ä¸­æ–‡ç¿»è¯‘ç¬¬äºŒè¡Œã€</tspan>
    </text>
  </g>
  
  <!-- ä¿¡æ¯æ  (y: 280-380) -->
  <g id="info">
    <!-- ä½¿ç”¨åˆ†åˆ—å¸ƒå±€é¿å…é‡å  -->
    <text x="100" y="340" text-anchor="middle" 
          font-size="12" fill="#fff">
      <tspan>å¯¼æ¼”ï¼šXXX</tspan>
    </text>
    
    <text x="250" y="340" text-anchor="middle" 
          font-size="12" fill="#fff">
      <tspan>ç±»å‹ï¼šXXX</tspan>
    </text>
    
    <text x="400" y="340" text-anchor="middle" 
          font-size="12" fill="#fff">
      <tspan>ç‰‡é•¿ï¼šXXX</tspan>
    </text>
    
    <text x="500" y="340" text-anchor="middle" 
          font-size="12" fill="#fff">
      <tspan>è¯„åˆ†ï¼šX.X</tspan>
    </text>
  </g>
</svg>
\`\`\`

ç›´æ¥è¿”å›å®Œæ•´çš„SVGä»£ç ï¼Œæ— éœ€å…¶ä»–è¯´æ˜ã€‚`,
                    variables: [],
                    source: 'preset',
                    author: 'system'
                },
                
                'preset-book-artistic': {
                    name: 'ğŸ“š è¯»ä¹¦ç¬”è®°å¡ç‰‡ï¼ˆè‰ºæœ¯ç‰ˆï¼‰',
                    type: 'book',
                    dimensions: '400x533',
                    style: 'artistic',
                    prompt: `ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„UIè®¾è®¡å¸ˆï¼Œæ“…é•¿æœ‰è‰ºæœ¯æ„Ÿçš„è¯»ä¹¦ç¬”è®°å¡ç‰‡è®¾è®¡ï¼Œå¹¶æŒ‰ç…§SVGå›¾ç‰‡ç»˜åˆ¶ã€‚

## ä»»åŠ¡è¦æ±‚
1. æ ¹æ®æŒ‡å®šçš„ä¹¦åï¼Œè·å–ä¹¦çš„ä½œè€…ï¼Œç®€ä»‹ï¼Œå†…å®¹æ€»ç»“ï¼Œå¹¶æ‘˜å½•ä¹¦ä¸­çš„ç²¾ç¾å¥å­
2. å°†è·å–çš„å†…å®¹è¿›è¡Œå¯è§†åŒ–ï¼Œä»¥SVGå›¾ç‰‡çš„å½¢å¼è¾“å‡º
3. SVGå›¾ç‰‡çš„èƒŒæ™¯è¯·æŒ‰ç…§æŒ‡å®šçš„èƒŒæ™¯è¿›è¡Œç»˜åˆ¶ï¼Œè¥é€ çº¸å¼ è´¨æ„Ÿ
4. è¯·å°†æ–‡æœ¬å†…å®¹æ¢æˆæ‘˜å½•çš„ä¹¦ç±å†…å®¹ï¼Œå¯ä»¥é€‚å½“ä¿®æ”¹æ ·å¼ä»¥é€‚åº”æ–‡æœ¬å†…å®¹

## SVGæ¨¡æ¿ç»“æ„
- **ç”»å¸ƒå°ºå¯¸**: 400px Ã— 533px
- **é…è‰²æ–¹æ¡ˆ**: æ¸©æš–çš„çº¸å¼ è‰²è°ƒ (#f5f2e9, #c4dccd)
- **å­—ä½“**: ä¼˜é›…çš„ä¸­æ–‡å­—ä½“æ­é…
- **å¸ƒå±€**: å±‚æ¬¡åˆ†æ˜çš„ä¿¡æ¯ç»“æ„

## è®¾è®¡å…ƒç´ 
- çº¸å¼ è´¨æ„ŸèƒŒæ™¯
- éšæœºçº¤ç»´è£…é¥°
- ä¼˜é›…çš„æ–‡å­—æ’ç‰ˆ
- è‰ºæœ¯æ„Ÿçš„è§†è§‰æ•ˆæœ

## SVGä»£ç æ¨¡æ¿
\`\`\`xml
<svg width="400" height="533" viewBox="0 0 400 533" xmlns="http://www.w3.org/2000/svg">
  <!-- å®šä¹‰æ¸å˜å’Œçº¹ç† -->
  <defs>
    <!-- çº¸å¼ æ¸å˜ -->
    <linearGradient id="paperGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#f5f2e9"/>
      <stop offset="40%" stop-color="#c4dccd"/>
      <stop offset="100%" stop-color="#f5f2e9"/>
    </linearGradient>
    
    <!-- çº¸å¼ çº¹ç†æ»¤é•œ -->
    <filter id="paperTexture">
      <feTurbulence baseFrequency="0.08" numOctaves="6" seed="5" stitchTiles="stitch"/>
      <feColorMatrix type="saturate" values="0"/>
    </filter>
  </defs>
  
  <!-- èƒŒæ™¯ -->
  <rect width="400" height="533" fill="url(#paperGradient)" filter="url(#paperTexture)" opacity="0.3"/>
  <rect width="400" height="533" fill="url(#paperGradient)"/>
  
  <!-- è£…é¥°çº¤ç»´ -->
  <g opacity="0.03" stroke="#3c3c3c" stroke-width="0.3" fill="none">
    <path d="M100,80 Q120,85 105,90"/>
    <path d="M200,130 Q220,135 205,145"/>
    <path d="M300,180 Q320,190 305,200"/>
    <path d="M150,250 Q160,260 145,270"/>
  </g>
  
  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
  <!-- è‹±æ–‡å¼•è¨€ -->
  <text x="200" y="100" text-anchor="middle" fill="#3c3c3c" font-size="20" font-family="Huiwen-MinchoGBK, SimSun, serif" font-weight="500">
    <tspan x="200" dy="0">[è‹±æ–‡åè¨€ç¬¬ä¸€è¡Œ]</tspan>
    <tspan x="200" dy="30">[è‹±æ–‡åè¨€ç¬¬äºŒè¡Œ]</tspan>
    <tspan x="200" dy="30">[è‹±æ–‡åè¨€ç¬¬ä¸‰è¡Œ]</tspan>
  </text>
  
  <!-- ä¸­æ–‡å¼•è¨€ -->
  <text x="200" y="260" text-anchor="middle" fill="#3c3c3c" font-size="24" font-family="Huiwen-MinchoGBK, SimSun, serif" font-weight="500">
    <tspan x="200" dy="0">[ä¸­æ–‡åè¨€ç¬¬ä¸€è¡Œ]</tspan>
    <tspan x="200" dy="35">[ä¸­æ–‡åè¨€ç¬¬äºŒè¡Œ]</tspan>
    <tspan x="200" dy="35">[ä¸­æ–‡åè¨€ç¬¬ä¸‰è¡Œ]</tspan>
  </text>
  
  <!-- æ„Ÿæ‚Ÿæ–‡å­— -->
  <text x="200" y="390" text-anchor="middle" fill="#5a5a5a" font-size="16" font-family="Huiwen-MinchoGBK, SimSun, serif" font-weight="400">
    <tspan x="200" dy="0">[ä¸ªäººæ„Ÿæ‚Ÿç¬¬ä¸€è¡Œ]</tspan>
    <tspan x="200" dy="25">[ä¸ªäººæ„Ÿæ‚Ÿç¬¬äºŒè¡Œ]</tspan>
    <tspan x="200" dy="25">[ä¸ªäººæ„Ÿæ‚Ÿç¬¬ä¸‰è¡Œ]</tspan>
    <tspan x="200" dy="25">[ä¸ªäººæ„Ÿæ‚Ÿç¬¬å››è¡Œ]</tspan>
  </text>
  
  <!-- ç­¾å -->
  <text x="200" y="490" text-anchor="middle" fill="#5a5a5a" font-size="16" font-family="Huiwen-MinchoGBK, SimSun, serif" font-weight="200">
    @è¯»ä¹¦ç¬”è®°
  </text>
</svg>
\`\`\`

ç›´æ¥è¿”å›å®Œæ•´çš„SVGä»£ç ï¼Œæ— éœ€å…¶ä»–è¯´æ˜ã€‚`,
                    variables: [],
                    source: 'preset',
                    author: 'system'
                }
            };
        }


        // å…¨å±€å˜é‡ç”¨äºè·Ÿè¸ªå½“å‰æ˜¯å¦ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿
        let isCustomTemplate = false;
        let basePrompt = '';
        let appliedMainContent = ''; // è®°ä½å·²åº”ç”¨çš„ä¸»ä½“å†…å®¹

        // å‚æ•°å˜åŒ–æ—¶çš„å¤„ç†å‡½æ•°
        function onParameterChange() {
            // å¦‚æœå½“å‰ä¸æ˜¯è‡ªå®šä¹‰æ¨¡æ¿çŠ¶æ€ï¼Œåˆ™æ›´æ–°æ¨¡æ¿
            if (!isCustomTemplate) {
                updatePromptTemplate();
                // å¦‚æœä¹‹å‰æœ‰åº”ç”¨è¿‡ä¸»ä½“å†…å®¹ï¼Œé‡æ–°åº”ç”¨
                if (appliedMainContent) {
                    reapplyMainContent();
                }
            } else {
                // å¦‚æœæ˜¯è‡ªå®šä¹‰æ¨¡æ¿çŠ¶æ€ï¼Œç»™å‡ºæç¤º
                showStatus('å½“å‰ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿ï¼Œå‚æ•°é€‰æ‹©ä¸ä¼šå½±å“æç¤ºè¯', 'warning');
            }
        }

        // æ›´æ–°æç¤ºè¯æ¨¡æ¿
        function updatePromptTemplate() {
            const cardType = document.getElementById('cardType').value;
            const dimensions = document.getElementById('dimensions').value;
            const style = document.getElementById('styleTheme').value;
            
            const templateKey = `${cardType}-${dimensions}-${style}`;
            const template = templates[templateKey];
            
            if (template) {
                basePrompt = template.prompt;
                currentPrompt = basePrompt;
                isCustomTemplate = false;
            } else {
                basePrompt = generateDefaultPrompt(cardType, dimensions, style);
                currentPrompt = basePrompt;
                isCustomTemplate = false;
            }
            
            document.getElementById('promptDisplay').textContent = currentPrompt;
            document.getElementById('promptEditor').value = currentPrompt;
        }

        // åº”ç”¨ä¸»ä½“å†…å®¹
        function applyMainContent() {
            const mainContent = document.getElementById('mainContent').value.trim();
            
            if (!mainContent) {
                showStatus('è¯·è¾“å…¥ä¸»ä½“å†…å®¹', 'error');
                return;
            }
            
            if (!basePrompt) {
                showStatus('è¯·å…ˆé€‰æ‹©æ¨¡æ¿æˆ–ç¼–è¾‘æç¤ºè¯', 'error');
                return;
            }
            
            // è®°ä½åº”ç”¨çš„ä¸»ä½“å†…å®¹
            appliedMainContent = mainContent;
            
            if (isCustomTemplate) {
                // å¯¹äºè‡ªå®šä¹‰æ¨¡æ¿ï¼Œåœ¨æœ«å°¾æ·»åŠ ä¸»ä½“å†…å®¹æŒ‡ä»¤
                currentPrompt = basePrompt + `\n\nè¯·å°±ä¸»ä½“å†…å®¹"${mainContent}"ä¸ºæˆ‘åˆ¶ä½œå¡ç‰‡ã€‚`;
            } else {
                // å¯¹äºé»˜è®¤æ¨¡æ¿ï¼Œåœ¨å¼€å¤´æ·»åŠ ä¸»ä½“å†…å®¹æŒ‡ä»¤
                currentPrompt = `è¯·å°±ä¸»ä½“å†…å®¹"${mainContent}"ä¸ºæˆ‘åˆ¶ä½œå¡ç‰‡ã€‚\n\n` + basePrompt;
            }
            
            document.getElementById('promptDisplay').textContent = currentPrompt;
            document.getElementById('promptEditor').value = currentPrompt;
            
            // å¯ç”¨ç”ŸæˆæŒ‰é’®
            document.getElementById('generateBtn').disabled = false;
            
            showStatus('ä¸»ä½“å†…å®¹å·²åº”ç”¨åˆ°æç¤ºè¯', 'success');
        }

        // é‡æ–°åº”ç”¨ä¸»ä½“å†…å®¹ï¼ˆå½“å‚æ•°å˜åŒ–æ—¶è°ƒç”¨ï¼‰
        function reapplyMainContent() {
            if (!appliedMainContent) return;
            
            if (isCustomTemplate) {
                // å¯¹äºè‡ªå®šä¹‰æ¨¡æ¿ï¼Œåœ¨æœ«å°¾æ·»åŠ ä¸»ä½“å†…å®¹æŒ‡ä»¤
                currentPrompt = basePrompt + `\n\nè¯·å°±ä¸»ä½“å†…å®¹"${appliedMainContent}"ä¸ºæˆ‘åˆ¶ä½œå¡ç‰‡ã€‚`;
            } else {
                // å¯¹äºé»˜è®¤æ¨¡æ¿ï¼Œåœ¨å¼€å¤´æ·»åŠ ä¸»ä½“å†…å®¹æŒ‡ä»¤
                currentPrompt = `è¯·å°±ä¸»ä½“å†…å®¹"${appliedMainContent}"ä¸ºæˆ‘åˆ¶ä½œå¡ç‰‡ã€‚\n\n` + basePrompt;
            }
            
            document.getElementById('promptDisplay').textContent = currentPrompt;
            document.getElementById('promptEditor').value = currentPrompt;
            
            // ä¿æŒç”ŸæˆæŒ‰é’®å¯ç”¨çŠ¶æ€
            document.getElementById('generateBtn').disabled = false;
        }

        // ç”Ÿæˆé»˜è®¤æç¤ºè¯
        function generateDefaultPrompt(cardType, dimensions, style) {
            const styleMap = {
                'fresh': 'æ¸…æ–°è‡ªç„¶ï¼Œç»¿è‰²ç³»é…è‰²',
                'business': 'å•†åŠ¡ä¸“ä¸šï¼Œè“ç°è‰²ç³»',
                'warm': 'æ¸©æš–æ–‡è‰ºï¼Œæ©™é»„è‰²ç³»',
                'tech': 'ç°ä»£ç§‘æŠ€ï¼Œè“ç´«è‰²ç³»'
            };
            
            const typeMap = {
                'word': 'è‹±è¯­å•è¯å­¦ä¹ å¡ç‰‡',
                'book': 'è¯»ä¹¦ç¬”è®°å¡ç‰‡',
                'movie': 'ç”µå½±æ”¶è—å¡ç‰‡',
                'custom': 'è‡ªå®šä¹‰å¡ç‰‡'
            };
            
            return `è¯·åˆ¶ä½œä¸€å¼ ${typeMap[cardType]}ï¼Œè¦æ±‚ï¼š

## å¡ç‰‡è§„æ ¼
- å°ºå¯¸ï¼š${dimensions}px
- é£æ ¼ï¼š${styleMap[style]}
- æ ¼å¼ï¼šå®Œæ•´çš„SVGä»£ç 

## è®¾è®¡è¦æ±‚
- æ ¹æ®å†…å®¹é€‰æ‹©åˆé€‚çš„é…è‰²æ–¹æ¡ˆ
- å¸ƒå±€æ¸…æ™°ï¼Œå±‚æ¬¡åˆ†æ˜
- é€‚å½“çš„è£…é¥°å…ƒç´ 
- ç¡®ä¿æ‰€æœ‰æ–‡å­—æ¸…æ™°å¯è¯»

ç›´æ¥è¿”å›å®Œæ•´çš„SVGä»£ç ï¼Œæ— éœ€å…¶ä»–è¯´æ˜ã€‚`;
        }

        // åŠ è½½è‡ªå®šä¹‰æ¨¡æ¿
        function loadCustomTemplates() {
            const saved = localStorage.getItem('aiCardMaker_customTemplates');
            if (saved) {
                try {
                    const customTemplates = JSON.parse(saved);
                    // åˆå¹¶è‡ªå®šä¹‰æ¨¡æ¿åˆ°templateså¯¹è±¡
                    Object.assign(templates, customTemplates);
                } catch (error) {
                    console.error('åŠ è½½è‡ªå®šä¹‰æ¨¡æ¿å¤±è´¥:', error);
                }
            }
        }


        // ä¿å­˜è‡ªå®šä¹‰æ¨¡æ¿
        function saveCustomTemplates() {
            const customTemplates = {};
            for (const [key, template] of Object.entries(templates)) {
                if (template.author === 'user') {
                    customTemplates[key] = template;
                }
            }
            localStorage.setItem('aiCardMaker_customTemplates', JSON.stringify(customTemplates));
        }

        // æ›´æ–°è‡ªå®šä¹‰æ¨¡æ¿åˆ—è¡¨
        function updateCustomTemplateList() {
            const templateList = document.getElementById('customTemplateList');
            templateList.innerHTML = '';
            
            // è·å–ç”¨æˆ·è‡ªå®šä¹‰æ¨¡æ¿å’Œé¢„è®¾æ¨¡æ¿
            const customTemplates = Object.entries(templates).filter(([key, template]) => 
                template.author === 'user' || template.source === 'preset'
            );
            
            if (customTemplates.length === 0) {
                templateList.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">æš‚æ— è‡ªå®šä¹‰æ¨¡æ¿</div>';
                return;
            }
            
            customTemplates.forEach(([key, template]) => {
                const templateItem = document.createElement('div');
                templateItem.className = 'template-item';
                
                // é¢„è®¾æ¨¡æ¿ä¸æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                const isPresetTemplate = template.source === 'preset';
                const deleteButton = isPresetTemplate ? '' : 
                    `<button class="delete-btn" onclick="deleteCustomTemplate('${key}')">åˆ é™¤</button>`;
                
                templateItem.innerHTML = `
                    <div class="template-name" onclick="loadCustomTemplate('${key}')">${template.name}</div>
                    <div class="template-actions">
                        <button class="load-btn" onclick="loadCustomTemplate('${key}')">åŠ è½½</button>
                        ${deleteButton}
                    </div>
                `;
                templateList.appendChild(templateItem);
            });
        }

        // åŠ è½½è‡ªå®šä¹‰æ¨¡æ¿
        function loadCustomTemplate(templateKey) {
            const template = templates[templateKey];
            if (template) {
                // è°ƒè¯•ä¿¡æ¯
                console.log('åŠ è½½è‡ªå®šä¹‰æ¨¡æ¿:');
                console.log('template.name:', template.name);
                console.log('template.prompt:', template.prompt);
                
                // ä¸æ›´æ–°å‚æ•°é€‰æ‹©å™¨ï¼Œä¿æŒè‡ªå®šä¹‰æ¨¡æ¿çš„ç‹¬ç«‹æ€§
                basePrompt = template.prompt;
                currentPrompt = basePrompt;
                isCustomTemplate = true;
                
                document.getElementById('promptDisplay').textContent = currentPrompt;
                document.getElementById('promptEditor').value = currentPrompt;
                showStatus(`å·²åŠ è½½è‡ªå®šä¹‰æ¨¡æ¿: ${template.name}`, 'success');
                
                // è°ƒè¯•ä¿¡æ¯
                console.log('åŠ è½½åçš„çŠ¶æ€:');
                console.log('isCustomTemplate:', isCustomTemplate);
                console.log('basePrompt:', basePrompt);
                console.log('currentPrompt:', currentPrompt);
            }
        }

        // åˆ é™¤è‡ªå®šä¹‰æ¨¡æ¿
        function deleteCustomTemplate(templateKey) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè‡ªå®šä¹‰æ¨¡æ¿å—ï¼Ÿ')) {
                delete templates[templateKey];
                saveCustomTemplates();
                updateCustomTemplateList();
                showStatus('æ¨¡æ¿å·²åˆ é™¤', 'success');
            }
        }

        // ä¿å­˜å½“å‰é…ç½®ä¸ºæ¨¡æ¿
        function saveCurrentAsTemplate() {
            const templateName = prompt('è¯·è¾“å…¥æ¨¡æ¿åç§°ï¼š');
            if (!templateName || !templateName.trim()) return;
            
            if (!basePrompt) {
                showStatus('è¯·å…ˆé€‰æ‹©å‚æ•°æˆ–ç¼–è¾‘æç¤ºè¯', 'error');
                return;
            }
            
            // è°ƒè¯•ä¿¡æ¯
            console.log('ä¿å­˜æ¨¡æ¿æ—¶çš„çŠ¶æ€:');
            console.log('isCustomTemplate:', isCustomTemplate);
            console.log('basePrompt:', basePrompt);
            console.log('currentPrompt:', currentPrompt);
            
            const templateKey = `custom_${Date.now()}`;
            templates[templateKey] = {
                name: templateName.trim(),
                type: 'custom',
                dimensions: 'custom',
                style: 'custom',
                prompt: basePrompt, // ä¿å­˜åŸºç¡€æç¤ºè¯ï¼Œä¸åŒ…å«ä¸»ä½“å†…å®¹
                variables: [],
                created: new Date().toISOString(),
                author: 'user'
            };
            
            saveCustomTemplates();
            updateCustomTemplateList();
            showStatus(`æ¨¡æ¿ "${templateName}" å·²ä¿å­˜`, 'success');
        }


        // ç”Ÿæˆå¡ç‰‡
        async function generateCard() {
            const apiKey = userSettings.apiKey;
            if (!apiKey) {
                showStatus('è¯·å…ˆé…ç½® API Key', 'error');
                return;
            }

            if (!currentPrompt) {
                showStatus('è¯·å…ˆé€‰æ‹©å‚æ•°å¹¶åº”ç”¨ä¸»ä½“å†…å®¹', 'error');
                return;
            }

            const finalPrompt = currentPrompt;
            
            console.log('å‘é€ç»™APIçš„æç¤ºè¯:', finalPrompt);
            
            showStatus('æ­£åœ¨ç”Ÿæˆå¡ç‰‡...', 'warning');
            document.getElementById('previewArea').classList.add('loading');

            try {
                const response = await fetchWithTimeout('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„SVGå¡ç‰‡è®¾è®¡å¸ˆï¼Œèƒ½å¤Ÿæ ¹æ®è¦æ±‚ç”Ÿæˆé«˜è´¨é‡çš„SVGä»£ç ã€‚'
                            },
                            {
                                role: 'user',
                                content: finalPrompt
                            }
                        ],
                        max_tokens: 4000,
                        temperature: 0.7
                    })
                }, 120000); // 120ç§’è¶…æ—¶ï¼ˆ2åˆ†é’Ÿï¼‰

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                const svgCode = extractSVGCode(data.choices[0].message.content);
                
                if (svgCode) {
                    currentSVG = svgCode;
                    displaySVG(svgCode);
                    showStatus('å¡ç‰‡ç”ŸæˆæˆåŠŸï¼', 'success');
                } else {
                    showStatus('æœªèƒ½ä»å“åº”ä¸­æå–SVGä»£ç ', 'error');
                }

            } catch (error) {
                showStatus(`ç”Ÿæˆå¤±è´¥ï¼š${error.message}`, 'error');
            } finally {
                document.getElementById('previewArea').classList.remove('loading');
            }
        }


        // æå–SVGä»£ç 
        function extractSVGCode(content) {
            const svgMatch = content.match(/<svg[\s\S]*?<\/svg>/i);
            return svgMatch ? svgMatch[0] : null;
        }

        // æ˜¾ç¤ºSVG
        function displaySVG(svgCode) {
            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = svgCode;
            previewArea.classList.add('has-content');
            
            // å¯ç”¨ä¸‹è½½æŒ‰é’®
            document.getElementById('downloadSVGBtn').disabled = false;
            document.getElementById('downloadPNGBtn').disabled = false;
            document.getElementById('copyBtn').disabled = false;
        }

        // ä¸‹è½½SVG
        function downloadSVG() {
            if (!currentSVG) return;
            
            const fileName = generateSafeFileName(appliedMainContent);
            const blob = new Blob([currentSVG], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}.svg`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶å
        function generateSafeFileName(content) {
            if (!content || content.trim() === '') {
                return 'card';
            }
            
            // ç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼Œåªä¿ç•™ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—å’Œå°‘æ•°å®‰å…¨å­—ç¬¦
            const safeName = content.trim()
                .replace(/[<>:"/\\|?*\x00-\x1f]/g, '') // ç§»é™¤Windowsä¸æ”¯æŒçš„å­—ç¬¦
                .replace(/\s+/g, '_') // å°†ç©ºæ ¼æ›¿æ¢ä¸ºä¸‹åˆ’çº¿
                .substring(0, 50); // é™åˆ¶é•¿åº¦
            
            return safeName || 'card';
        }
        
        // ä»SVGä¸­æå–åŸå§‹å°ºå¯¸
        function getSVGDimensions(svgCode) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(svgCode, 'image/svg+xml');
            const svg = doc.querySelector('svg');
            
            if (!svg) return { width: 400, height: 400 };
            
            // å°è¯•ä»widthå’Œheightå±æ€§è·å–
            let width = svg.getAttribute('width');
            let height = svg.getAttribute('height');
            
            if (width && height) {
                // ç§»é™¤å•ä½ï¼Œè·å–æ•°å€¼
                width = parseInt(width.replace(/[^\d]/g, '')) || 400;
                height = parseInt(height.replace(/[^\d]/g, '')) || 400;
                return { width, height };
            }
            
            // å°è¯•ä»viewBoxè·å–
            const viewBox = svg.getAttribute('viewBox');
            if (viewBox) {
                const values = viewBox.split(' ').map(v => parseFloat(v));
                if (values.length === 4) {
                    return { width: values[2], height: values[3] };
                }
            }
            
            // é»˜è®¤å°ºå¯¸
            return { width: 400, height: 400 };
        }
        
        // æ˜¾ç¤ºPNGé€‰é¡¹
        function showPNGOptions() {
            if (!currentSVG) return;
            document.getElementById('pngOptionsModal').style.display = 'flex';
        }

        // å…³é—­PNGé€‰é¡¹
        function closePNGOptions() {
            document.getElementById('pngOptionsModal').style.display = 'none';
        }

        // ä½¿ç”¨é€‰é¡¹ä¸‹è½½PNG
        function downloadPNGWithOptions() {
            if (!currentSVG) return;
            
            // ä½¿ç”¨SVGåŸå§‹å°ºå¯¸ï¼Œè€Œä¸æ˜¯å¡ç‰‡å°ºå¯¸å‚æ•°
            const svgDimensions = getSVGDimensions(currentSVG);
            const width = svgDimensions.width;
            const height = svgDimensions.height;
            const scale = parseInt(document.getElementById('pngScale').value);
            const background = document.getElementById('pngBackground').value;
            
            convertSVGToPNG(currentSVG, width, height, scale, background).then(blob => {
                if (blob) {
                    const fileName = generateSafeFileName(appliedMainContent);
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${fileName}_${scale}x.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showStatus('PNG ä¸‹è½½æˆåŠŸ', 'success');
                    closePNGOptions();
                } else {
                    showStatus('PNG è½¬æ¢å¤±è´¥', 'error');
                }
            }).catch(error => {
                showStatus('PNG è½¬æ¢å¤±è´¥: ' + error.message, 'error');
            });
        }

        // SVGè½¬PNGæ ¸å¿ƒå‡½æ•°
        function convertSVGToPNG(svgCode, width, height, scale = 2, background = 'transparent') {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = width * scale;
                canvas.height = height * scale;

                // è®¾ç½®èƒŒæ™¯è‰²
                if (background !== 'transparent') {
                    ctx.fillStyle = background;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }

                const img = new Image();
                
                img.onload = () => {
                    try {
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('è½¬æ¢å¤±è´¥'));
                            }
                        }, 'image/png');
                    } catch (error) {
                        reject(error);
                    }
                };

                img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
                
                const svgBlob = new Blob([svgCode], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(svgBlob);
                img.src = url;
            });
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard() {
            if (!currentSVG) return;
            
            navigator.clipboard.writeText(currentSVG).then(() => {
                showStatus('SVGä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                showStatus('å¤åˆ¶å¤±è´¥', 'error');
            });
        }

        // åˆ‡æ¢é«˜çº§æ¨¡å¼
        function toggleAdvancedMode() {
            const advancedMode = document.getElementById('advancedMode');
            advancedMode.classList.toggle('show');
        }

        // åº”ç”¨è‡ªå®šä¹‰æç¤ºè¯
        function applyCustomPrompt() {
            const customPrompt = document.getElementById('promptEditor').value;
            currentPrompt = customPrompt;
            basePrompt = customPrompt; // åŒæ—¶æ›´æ–°basePromptï¼Œè¿™æ ·ä¿å­˜æ¨¡æ¿æ—¶ä¼šä¿å­˜æ­£ç¡®çš„å†…å®¹
            isCustomTemplate = true; // æ ‡è®°ä¸ºè‡ªå®šä¹‰æ¨¡æ¿çŠ¶æ€
            document.getElementById('promptDisplay').textContent = customPrompt;
            showStatus('è‡ªå®šä¹‰æç¤ºè¯å·²åº”ç”¨', 'success');
        }

        // é‡ç½®ä¸ºé»˜è®¤æ¨¡æ¿
        function resetToDefaultTemplate() {
            isCustomTemplate = false;
            updatePromptTemplate();
            showStatus('å·²é‡ç½®ä¸ºé»˜è®¤æ¨¡æ¿æ¨¡å¼', 'success');
        }


        // å¯¼å‡ºæ¨¡æ¿
        function exportTemplate() {
            const dataStr = JSON.stringify(templates, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'card-templates.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(message, type) {
            const statusBar = document.getElementById('statusBar');
            const statusText = document.getElementById('statusText');
            
            statusText.textContent = message;
            statusBar.className = `status-bar show ${type}`;
            
            if (type === 'success') {
                setTimeout(() => {
                    statusBar.classList.remove('show');
                }, 3000);
            }
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'g') {
                e.preventDefault();
                generateCard();
            } else if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (currentSVG) {
                    downloadSVG();
                }
            } else if (e.key === 'Escape') {
                closePNGOptions();
            }
        });

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.addEventListener('click', function(e) {
            if (e.target.id === 'pngOptionsModal') {
                closePNGOptions();
            }
        });
    </script>
</body>
</html>