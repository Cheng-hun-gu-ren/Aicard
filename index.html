<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI卡片制作器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 15px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .api-config {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            position: relative;
        }

        .api-status {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
            z-index: 100;
        }

        .api-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .api-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .api-status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .api-config input {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .api-config input:focus {
            outline: none;
            border-color: #667eea;
        }

        .api-config button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .api-config button:hover {
            background: #5a67d8;
        }

        .param-selector {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .param-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .param-group {
            flex: 1;
            min-width: 200px;
        }

        .param-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .param-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s;
        }

        .param-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .content-input {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .content-input h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            min-height: 600px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .panel h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #5a6268;
        }

        .btn.success {
            background: #28a745;
        }

        .btn.success:hover {
            background: #218838;
        }

        .btn.danger {
            background: #dc3545;
        }

        .btn.danger:hover {
            background: #c82333;
        }

        .preview-area {
            flex: 1;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            text-align: center;
            color: #6c757d;
            position: relative;
        }

        .preview-area.has-content {
            border-color: #28a745;
            background: white;
        }

        .preview-controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .prompt-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .prompt-display {
            flex: 1;
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 400px;
        }

        .prompt-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .template-selector {
            margin-bottom: 15px;
        }

        .template-selector select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .status-bar {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: none;
        }

        .status-bar.show {
            display: block;
        }

        .status-bar.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-bar.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-bar.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .loading {
            position: relative;
            opacity: 0.7;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            margin: -20px 0 0 -20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .advanced-mode {
            margin-top: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 8px;
            display: none;
        }

        .advanced-mode.show {
            display: block;
        }

        .advanced-mode textarea {
            width: 100%;
            height: 200px;
            padding: 12px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
        }

        .color-theme {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .color-theme:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .color-theme.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .color-theme.fresh {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .color-theme.business {
            background: linear-gradient(45deg, #3498db, #2c3e50);
        }

        .color-theme.warm {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .color-theme.tech {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
        }

        .theme-name {
            color: white;
            font-weight: 600;
            text-align: center;
            font-size: 14px;
        }

        .png-options-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .option-group {
            margin-bottom: 20px;
        }

        .option-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .option-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .param-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .param-section .param-group {
            margin-bottom: 15px;
        }

        .param-section .param-group:last-child {
            margin-bottom: 0;
        }

        .custom-templates {
            margin-bottom: 20px;
        }

        .custom-templates h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
        }

        .template-list {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .template-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e9ecef;
        }

        .template-item:hover {
            background: #e9ecef;
        }

        .template-name {
            font-weight: 500;
            color: #333;
            cursor: pointer;
        }

        .template-actions {
            display: flex;
            gap: 5px;
        }

        .template-actions button {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .template-actions .load-btn {
            background: #667eea;
            color: white;
        }

        .template-actions .delete-btn {
            background: #dc3545;
            color: white;
        }

        .content-section {
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
            border-radius: 15px;
            border: 2px solid #c1d3ff;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }
        
        .content-section:hover {
            border-color: #667eea;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.15);
        }
        
        .content-section label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #4a5568;
            font-size: 16px;
        }

        .input-with-button {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .input-with-button textarea {
            flex: 1;
            min-height: 80px;
            resize: vertical;
            font-size: 18px;
            line-height: 1.5;
            border: 2px solid #d1d9e6;
            border-radius: 12px;
            padding: 15px;
            background: white;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .input-with-button textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .apply-btn {
            padding: 10px 20px;
            font-size: 14px;
            white-space: nowrap;
            margin-top: 0;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .input-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .param-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .param-group {
                min-width: 100%;
            }
            
            .api-config {
                flex-direction: column;
            }
            
            .api-config input {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部配置区 -->
        <div class="header">
            <h1>🎨 AI卡片制作器</h1>
            <div style="text-align: center; margin: 10px 0; padding: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-size: 14px;">
                📱 关注公众号：<strong>晨昏故人</strong> 获取更多AI实用玩法
            </div>
            <div class="api-config">
                <input type="password" id="apiKey" placeholder="请输入 DeepSeek API Key">
                <button onclick="saveApiKey()">保存</button>
                <button onclick="testApiKey()" id="testApiBtn">测试连接</button>
                <div class="api-status" id="apiStatus"></div>
            </div>
        </div>


        <!-- 主要工作区 -->
        <div class="main-content">
            <!-- 左栏：预览区域 -->
            <div class="panel">
                <h2>🖼️ 预览效果</h2>
                <div class="preview-area" id="previewArea">
                    <div>
                        <p>🎨 卡片预览区域</p>
                        <p>选择参数并填写内容后点击生成</p>
                    </div>
                </div>
                <div class="preview-controls">
                    <button class="btn" onclick="generateCard()" id="generateBtn" disabled>
                        ✨ 生成卡片
                    </button>
                    <button class="btn secondary" onclick="downloadSVG()" id="downloadSVGBtn" disabled>
                        📄 下载 SVG
                    </button>
                    <button class="btn success" onclick="showPNGOptions()" id="downloadPNGBtn" disabled>
                        🖼️ 下载 PNG
                    </button>
                    <button class="btn secondary" onclick="copyToClipboard()" id="copyBtn" disabled>
                        📋 复制代码
                    </button>
                </div>
                
                <!-- PNG选项弹窗 -->
                <div class="png-options-modal" id="pngOptionsModal" style="display: none;">
                    <div class="modal-content">
                        <h3>PNG 导出选项</h3>
                        <div class="option-group">
                            <label>缩放倍数</label>
                            <select id="pngScale">
                                <option value="1">1x (标准)</option>
                                <option value="2" selected>2x (高清)</option>
                                <option value="3">3x (超高清)</option>
                                <option value="4">4x (4K)</option>
                            </select>
                        </div>
                        <div class="option-group">
                            <label>背景色</label>
                            <select id="pngBackground">
                                <option value="transparent">透明</option>
                                <option value="white" selected>白色</option>
                                <option value="black">黑色</option>
                            </select>
                        </div>
                        <div class="modal-buttons">
                            <button class="btn" onclick="downloadPNGWithOptions()">下载 PNG</button>
                            <button class="btn secondary" onclick="closePNGOptions()">取消</button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- 右栏：提示词管理 -->
            <div class="panel">
                <h2>⚙️ 提示词管理</h2>
                
                <!-- 主体内容输入区 -->
                <div class="content-section">
                    <div class="param-group">
                        <label for="mainContent">主体内容</label>
                        <div class="input-with-button">
                            <textarea id="mainContent" placeholder="输入主体内容（如：单词、电影名、书名等）"></textarea>
                            <button class="btn apply-btn" onclick="applyMainContent()">应用</button>
                        </div>
                    </div>
                </div>
                
                <!-- 参数选择区 -->
                <div class="param-section">
                    <div class="param-group">
                        <label for="cardType">卡片类型</label>
                        <select id="cardType" onchange="onParameterChange()">
                            <option value="word">单词学习卡片</option>
                            <option value="book">读书笔记卡片</option>
                            <option value="movie">电影收藏卡片</option>
                            <option value="custom">自定义卡片</option>
                        </select>
                    </div>
                    <div class="param-group">
                        <label for="dimensions">卡片尺寸</label>
                        <select id="dimensions" onchange="onParameterChange()">
                            <option value="800x500">800x500 (横版)</option>
                            <option value="500x800">500x800 (竖版)</option>
                            <option value="600x600">600x600 (正方形)</option>
                            <option value="400x400">400x400 (小正方形)</option>
                            <option value="1000x600">1000x600 (宽屏)</option>
                        </select>
                    </div>
                    <div class="param-group">
                        <label for="styleTheme">风格主题</label>
                        <select id="styleTheme" onchange="onParameterChange()">
                            <option value="fresh">🌿 清新风格</option>
                            <option value="business">💼 商务风格</option>
                            <option value="warm">🌅 温暖风格</option>
                            <option value="tech">🚀 科技风格</option>
                        </select>
                    </div>
                </div>
                
                <!-- 自定义模板管理 -->
                <div class="custom-templates">
                    <h3>模板管理</h3>
                    <div class="template-list" id="customTemplateList">
                        <!-- 动态生成的模板列表 -->
                    </div>
                    <button class="btn secondary" onclick="saveCurrentAsTemplate()">
                        💾 保存当前配置
                    </button>
                    <button class="btn secondary" onclick="resetToDefaultTemplate()" style="margin-top: 10px;">
                        🔄 重置为默认模板
                    </button>
                </div>
                
                <!-- 提示词编辑器 -->
                <div class="prompt-editor">
                    <div class="prompt-display" id="promptDisplay">
                        当前提示词将在这里显示...
                    </div>
                    <div class="prompt-controls">
                        <button class="btn secondary" onclick="toggleAdvancedMode()">
                            🔧 高级编辑
                        </button>
                        <button class="btn secondary" onclick="exportTemplate()">
                            📤 导出模板
                        </button>
                    </div>
                    <div class="advanced-mode" id="advancedMode">
                        <textarea id="promptEditor" placeholder="在此编辑提示词..."></textarea>
                        <button class="btn" onclick="applyCustomPrompt()">应用自定义提示词</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 状态栏 -->
        <div class="status-bar" id="statusBar">
            <span id="statusText"></span>
        </div>
    </div>

    <script>
        // 全局变量
        let currentSVG = '';
        let currentPrompt = '';
        let templates = {};
        let userSettings = {};

        // 带超时的fetch函数
        async function fetchWithTimeout(url, options = {}, timeout = 60000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('请求超时，请尝试简化提示词或稍后重试');
                }
                throw error;
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadUserSettings();
            initializeTemplates();
            loadCustomTemplates();
            updatePromptTemplate();
            updateCustomTemplateList();
        });

        // 本地存储管理
        function loadUserSettings() {
            const saved = localStorage.getItem('aiCardMaker_settings');
            if (saved) {
                userSettings = JSON.parse(saved);
                if (userSettings.apiKey) {
                    document.getElementById('apiKey').value = userSettings.apiKey;
                    document.getElementById('generateBtn').disabled = false;
                }
            }
        }

        function saveUserSettings() {
            localStorage.setItem('aiCardMaker_settings', JSON.stringify(userSettings));
        }

        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (apiKey) {
                userSettings.apiKey = apiKey;
                saveUserSettings();
                document.getElementById('generateBtn').disabled = false;
                showStatus('API Key 已保存', 'success');
            } else {
                showStatus('请输入有效的 API Key', 'error');
            }
        }

        async function testApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const apiStatus = document.getElementById('apiStatus');
            const testBtn = document.getElementById('testApiBtn');
            
            if (!apiKey) {
                showApiStatus('请先输入 API Key', 'error');
                return;
            }

            // 显示加载状态
            testBtn.disabled = true;
            testBtn.textContent = '测试中...';
            showApiStatus('正在测试 API 连接...', 'loading');

            try {
                const response = await fetchWithTimeout('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            { role: 'user', content: '测试连接' }
                        ],
                        max_tokens: 10
                    })
                }, 30000); // 30秒超时

                if (response.ok) {
                    showApiStatus('✅ API 连接测试成功！', 'success');
                    userSettings.apiKey = apiKey;
                    saveUserSettings();
                    document.getElementById('generateBtn').disabled = false;
                    
                    // 3秒后隐藏成功消息
                    setTimeout(() => {
                        apiStatus.style.display = 'none';
                    }, 3000);
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showApiStatus(`❌ API 连接失败: ${errorData.error?.message || '请检查 API Key'}`, 'error');
                }
            } catch (error) {
                showApiStatus(`❌ 网络连接失败: ${error.message}`, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = '测试连接';
            }
        }

        function showApiStatus(message, type) {
            const apiStatus = document.getElementById('apiStatus');
            apiStatus.textContent = message;
            apiStatus.className = `api-status ${type}`;
            apiStatus.style.display = 'block';
        }

        // 初始化模板
        function initializeTemplates() {
            templates = {
                'word-800x500-fresh': {
                    name: '单词卡片-横版-清新风格',
                    type: 'word',
                    dimensions: '800x500',
                    style: 'fresh',
                    prompt: `请制作一张单词学习卡片，要求：

## 卡片规格
- 尺寸：800x500px
- 风格：清新自然，绿色系配色
- 格式：完整的SVG代码

## 设计要求
- 使用清新的绿色系配色（#27ae60, #2ecc71, #a8e6cf）
- 字体清晰易读，层次分明
- 适当的装饰元素，体现学习主题
- 所有文字必须在安全区域内
- 根据主体内容自动补充相关信息（如音标、释义、例句等）

直接返回完整的SVG代码，无需其他说明。`,
                    variables: []
                },
                'book-600x600-warm': {
                    name: '读书笔记-正方形-温暖风格',
                    type: 'book',
                    dimensions: '600x600',
                    style: 'warm',
                    prompt: `请制作一张读书笔记卡片，要求：

## 卡片规格
- 尺寸：600x600px
- 风格：温暖文艺，橙黄色系
- 格式：完整的SVG代码

## 设计要求
- 使用温暖的橙黄色系配色（#f39c12, #e67e22, #ffd89b）
- 营造纸张质感，体现读书氛围
- 适当的装饰元素（书籍、羽毛笔等）
- 文字排版优雅，易于阅读
- 根据主体内容自动补充相关信息（如作者、主题、金句等）

直接返回完整的SVG代码，无需其他说明。`,
                    variables: []
                },
                'movie-800x500-tech': {
                    name: '电影收藏-横版-科技风格',
                    type: 'movie',
                    dimensions: '800x500',
                    style: 'tech',
                    prompt: `请制作一张电影收藏卡片，要求：

## 卡片规格
- 尺寸：800x500px
- 风格：现代科技，蓝紫色系
- 格式：完整的SVG代码

## 设计要求
- 使用现代科技感的蓝紫色系配色（#3498db, #9b59b6, #667eea）
- 简洁现代的设计风格
- 适当的几何装饰元素
- 突出电影主题的视觉效果
- 根据主体内容自动补充相关信息（如导演、年份、台词等）

直接返回完整的SVG代码，无需其他说明。`,
                    variables: []
                },
                'custom-400x600-simple': {
                    name: '自定义卡片-竖版-简约风格',
                    type: 'custom',
                    dimensions: '400x600',
                    style: 'simple',
                    prompt: `请制作一张自定义卡片，要求：

## 卡片规格
- 尺寸：400x600px
- 风格：简约现代
- 格式：完整的SVG代码

## 设计要求
- 根据内容选择合适的配色方案
- 布局清晰，层次分明
- 适当的装饰元素，不喧宾夺主
- 确保所有文字清晰可读

直接返回完整的SVG代码，无需其他说明。`,
                    variables: []
                },
                
                // 预设优质模板
                'preset-word-advanced': {
                    name: '🎓 英语单词学习卡片（高级版）',
                    type: 'word',
                    dimensions: '800x1000',
                    style: 'educational',
                    prompt: `# 英语单词学习卡片 SVG 生成模板

## 卡片规格
- **尺寸**: 800px × 1000px
- **背景**: 白色 (#FFFFFF)
- **边框**: 2px 实线，圆角 12px
- **字体**: Arial, sans-serif
- **配色方案**:
  - 标题色: #2C3E50
  - 重点色: #E74C3C
  - 次要色: #3498DB
  - 文本色: #34495E
  - 背景色: #ECF0F1

## SVG 结构模板

\`\`\`svg
<svg width="800" height="1000" xmlns="http://www.w3.org/2000/svg">
  <!-- 背景和边框 -->
  <rect x="2" y="2" width="796" height="996" rx="12" fill="#FFFFFF" stroke="#2C3E50" stroke-width="2"/>
  
  <!-- 标题区域 (y: 20-100) -->
  <rect x="20" y="20" width="760" height="80" rx="8" fill="#2C3E50"/>
  <text x="400" y="65" text-anchor="middle" font-size="36" font-weight="bold" fill="#FFFFFF">[单词]</text>
  <text x="400" y="90" text-anchor="middle" font-size="20" fill="#FFFFFF">[音标] · [词性缩写]</text>
  
  <!-- 频率标记 (y: 110-130) -->
  <text x="40" y="125" font-size="16" fill="#34495E">[频率等级] [使用场景]</text>
  
  <!-- 分隔线 -->
  <line x1="40" y1="140" x2="760" y2="140" stroke="#ECF0F1" stroke-width="2"/>
  
  <!-- 快速理解区 (y: 150-280) -->
  <text x="40" y="170" font-size="20" font-weight="bold" fill="#2C3E50">快速理解</text>
  <rect x="40" y="180" width="720" height="90" rx="6" fill="#ECF0F1"/>
  <text x="60" y="210" font-size="18" fill="#E74C3C">构词: [词根]·[词缀]</text>
  <text x="60" y="235" font-size="16" fill="#34495E">核心含义: [核心含义]</text>
  <text x="60" y="260" font-size="16" fill="#34495E">最终解释: [最终解释]</text>
  
  <!-- 分隔线 -->
  <line x1="40" y1="290" x2="760" y2="290" stroke="#ECF0F1" stroke-width="2"/>
  
  <!-- 词根价值区 (y: 300-480) -->
  <text x="40" y="320" font-size="20" font-weight="bold" fill="#2C3E50">词根价值</text>
  <rect x="40" y="330" width="350" height="140" rx="6" fill="#F8F9FA"/>
  <text x="60" y="355" font-size="18" fill="#3498DB">词根: [词根]</text>
  <text x="60" y="380" font-size="16" fill="#34495E">含义: [基本含义]</text>
  <text x="60" y="405" font-size="16" fill="#34495E">频率: [词根频率等级]</text>
  <!-- 词根家族示例 -->
  <text x="60" y="435" font-size="14" fill="#34495E">[家族词1] - [含义1]</text>
  <text x="60" y="455" font-size="14" fill="#34495E">[家族词2] - [含义2]</text>
  
  <!-- 词缀价值区 (y: 300-480, 右侧) -->
  <rect x="410" y="330" width="350" height="140" rx="6" fill="#F8F9FA"/>
  <text x="430" y="355" font-size="18" fill="#3498DB">词缀: [词缀]</text>
  <text x="430" y="380" font-size="16" fill="#34495E">规律: [变化规律]</text>
  <text x="430" y="405" font-size="16" fill="#34495E">频率: [词缀频率等级]</text>
  <!-- 词缀搭配示例 -->
  <text x="430" y="435" font-size="14" fill="#34495E">[例词1] - [含义1]</text>
  <text x="430" y="455" font-size="14" fill="#34495E">[例词2] - [含义2]</text>
  
  <!-- 分隔线 -->
  <line x1="40" y1="490" x2="760" y2="490" stroke="#ECF0F1" stroke-width="2"/>
  
  <!-- 实用搭配区 (y: 500-720) -->
  <text x="40" y="520" font-size="20" font-weight="bold" fill="#2C3E50">实用搭配</text>
  <!-- 搭配示例 -->
  <rect x="40" y="530" width="720" height="80" rx="6" fill="#FFF5F5"/>
  <text x="60" y="555" font-size="16" font-weight="bold" fill="#E74C3C">常用搭配</text>
  <text x="60" y="580" font-size="14" fill="#34495E">[搭配1] - [释义1] ([场景1])</text>
  <text x="60" y="600" font-size="14" fill="#34495E">[搭配2] - [释义2] ([场景2])</text>
  
  <!-- 记忆技巧区 (y: 620-720) -->
  <rect x="40" y="620" width="350" height="90" rx="6" fill="#F0F8FF"/>
  <text x="60" y="645" font-size="16" font-weight="bold" fill="#3498DB">记忆技巧</text>
  <text x="60" y="670" font-size="14" fill="#34495E">[技巧1]</text>
  <text x="60" y="690" font-size="14" fill="#34495E">[技巧2]</text>
  
  <!-- 易混点提示区 (y: 620-720, 右侧) -->
  <rect x="410" y="620" width="350" height="90" rx="6" fill="#FFF8F0"/>
  <text x="430" y="645" font-size="16" font-weight="bold" fill="#F39C12">易混点提示</text>
  <text x="430" y="670" font-size="14" fill="#34495E">[易混词]: [区分方法]</text>
  <text x="430" y="690" font-size="14" fill="#34495E">[提示说明]</text>
  
  <!-- 分隔线 -->
  <line x1="40" y1="730" x2="760" y2="730" stroke="#ECF0F1" stroke-width="2"/>
  
  <!-- 底部总结区 (y: 740-980) -->
  <rect x="40" y="740" width="720" height="220" rx="8" fill="#2C3E50"/>
  <text x="400" y="770" text-anchor="middle" font-size="18" font-weight="bold" fill="#FFFFFF">记忆要点</text>
  <!-- 关键信息汇总 -->
  <text x="60" y="800" font-size="16" fill="#FFFFFF">• 词根 [词根] = [含义] (派生词[数量]+)</text>
  <text x="60" y="825" font-size="16" fill="#FFFFFF">• 词缀 [词缀] = [规律] (使用率[排名])</text>
  <text x="60" y="850" font-size="16" fill="#FFFFFF">• 核心记忆: [最简记忆法]</text>
  <text x="60" y="875" font-size="16" fill="#FFFFFF">• 使用场景: [主要场景]</text>
  <!-- 相关词汇网络 -->
  <text x="60" y="910" font-size="14" fill="#ECF0F1">相关词汇: [词1], [词2], [词3]</text>
  <text x="60" y="935" font-size="14" fill="#ECF0F1">近义词组: [近义词1], [近义词2]</text>
</svg>
\`\`\`

## 使用说明

### 频率等级标记
- 🔴 极高频：教育部考纲核心词汇前3000
- 🔵 高频：教育部考纲核心词汇3000-5000  
- ⚪️ 中频：教育部考纲核心词汇5000-8000

### 词根频率等级
- 🔴 派生词100+
- 🔵 派生词50-100
- ⚪️ 派生词20-50

### 词缀频率等级
- 🔴 使用率top20
- 🔵 使用率20-50
- ⚪️ 使用率50后

### 使用场景标记
- 考试常用：各类语言考试高频词
- 学术常用：学术论文常见用词
- 商务常用：商业环境常用词
- 日常常用：日常交流高频词
- 专业领域常用：特定专业场景用词

## 生成要求

1. **固定布局**：严格按照上述坐标和尺寸生成各区域
2. **颜色统一**：使用指定的配色方案，确保视觉一致性
3. **字体规范**：
   - 标题：36px/20px
   - 小标题：20px
   - 正文：16px/14px
4. **内容精简**：每个区域的文本要简洁明了，避免过长
5. **重点突出**：使用颜色和字重区分重要信息
6. **留白适当**：保持元素间距，避免拥挤

## 示例请求格式

"请使用上述SVG模板为单词 [单词] 生成学习卡片，重点关注[特定需求，如：词根记忆/易混词辨析/使用场景等]"`,
                    variables: [],
                    source: 'preset',
                    author: 'system'
                },
                
                'preset-movie-cinematic': {
                    name: '🎬 电影收藏卡片（电影级）',
                    type: 'movie',
                    dimensions: '600x400',
                    style: 'cinematic',
                    prompt: `# 电影卡片制作提示词 v2.0

## 角色定义
你是一位精通SVG技术和视觉设计的电影海报设计师，专注于创作精美的横向电影收藏卡片。你深知SVG文本布局的技术细节，能够精确控制文字位置和大小，避免任何视觉问题。

## 核心任务

### 1. 信息收集与整理
- **必需信息**：片名（原语言+英文+中文）、导演、年份、片长、类型
- **核心内容**：精炼的一句话剧情、主题精神
- **经典元素**：1-2句经典台词（原语言版本优先）、关键视觉符号
- **评分数据**：IMDb评分、豆瓣评分
- **语言处理**：根据电影来源国自动调整显示语言

### 2. SVG技术规范
- **画布尺寸**：600×400px（固定比例）
- **安全边距**：四周各留20px边距
- **文字防溢出**：所有文本必须设置合理的最大宽度
- **层级管理**：使用SVG分组确保元素不重叠

### 3. 文字布局规则

#### 防止文字问题的关键措施：
\`\`\`xml
<!-- 文字安全规则 -->
1. 所有文本使用 text-anchor 精确定位
2. 长文本必须分行显示，使用 <tspan> 元素
3. 设置合理的 font-size，确保可读性
4. 为每个文本区域预留足够空间
5. 使用 dominant-baseline 控制垂直对齐
\`\`\`

#### 文字大小规范：
- **片名**：24-28px（根据长度调整）
- **英文名**：16-18px
- **经典台词**：14-16px（必须分行）
- **基础信息**：12-14px
- **最小字号**：不小于10px

## 多语言显示规则

### 电影来源地区判断
1. **欧美电影**（美国、英国、法国、德国、意大利等）
   - 第一行：英文原名
   - 第二行：中文译名
   - 台词：英文原文 + 中文翻译

2. **日本电影**
   - 第一行：日文原名（假名+汉字）
   - 第二行：英文名 / 罗马音
   - 第三行：中文译名（较小字号）
   - 台词：日文原文 + 中文翻译

3. **韩国电影**
   - 第一行：韩文原名
   - 第二行：英文名 / 罗马音
   - 第三行：中文译名（较小字号）
   - 台词：韩文原文 + 中文翻译

4. **华语电影**（中国大陆、香港、台湾）
   - 第一行：中文名
   - 第二行：英文名
   - 台词：中文原文

## SVG代码模板

\`\`\`xml
<svg width="600" height="400" viewBox="0 0 600 400">
  <!-- 定义渐变和滤镜 -->
  <defs>
    <linearGradient id="bgGradient">
      <!-- 渐变色彩 -->
    </linearGradient>
    
    <!-- 文字阴影滤镜 -->
    <filter id="textShadow">
      <feDropShadow dx="1" dy="1" stdDeviation="1" flood-opacity="0.3"/>
    </filter>
  </defs>
  
  <!-- 背景层 -->
  <rect width="600" height="400" fill="url(#bgGradient)"/>
  
  <!-- 标题区域 (y: 20-100) -->
  <g id="header">
    <!-- 原语言标题 -->
    <text x="300" y="45" text-anchor="middle" 
          font-size="24" font-weight="bold" fill="#fff"
          font-family="'Noto Sans', Arial Unicode MS">
      <tspan>原语言标题</tspan>
    </text>
    
    <!-- 英文/罗马音标题 -->
    <text x="300" y="70" text-anchor="middle" 
          font-size="16" fill="#fff" opacity="0.9">
      <tspan>English Title / Romanization</tspan>
    </text>
    
    <!-- 中文标题（如需要） -->
    <text x="300" y="90" text-anchor="middle" 
          font-size="14" fill="#fff" opacity="0.7">
      <tspan>中文译名 (年份)</tspan>
    </text>
  </g>
  
  <!-- 引言区域 (y: 120-250) -->
  <g id="quote">
    <!-- 原语言台词 -->
    <text x="300" y="150" text-anchor="middle" 
          font-size="16" fill="#fff" font-style="italic"
          font-family="'Noto Sans', Arial Unicode MS">
      <tspan x="300" dy="0">原语言台词第一行</tspan>
      <tspan x="300" dy="25">原语言台词第二行</tspan>
    </text>
    
    <!-- 中文翻译 -->
    <text x="300" y="210" text-anchor="middle" 
          font-size="14" fill="#fff" opacity="0.85">
      <tspan x="300" dy="0">「中文翻译第一行</tspan>
      <tspan x="300" dy="22">中文翻译第二行」</tspan>
    </text>
  </g>
  
  <!-- 信息栏 (y: 280-380) -->
  <g id="info">
    <!-- 使用分列布局避免重叠 -->
    <text x="100" y="340" text-anchor="middle" 
          font-size="12" fill="#fff">
      <tspan>导演：XXX</tspan>
    </text>
    
    <text x="250" y="340" text-anchor="middle" 
          font-size="12" fill="#fff">
      <tspan>类型：XXX</tspan>
    </text>
    
    <text x="400" y="340" text-anchor="middle" 
          font-size="12" fill="#fff">
      <tspan>片长：XXX</tspan>
    </text>
    
    <text x="500" y="340" text-anchor="middle" 
          font-size="12" fill="#fff">
      <tspan>评分：X.X</tspan>
    </text>
  </g>
</svg>
\`\`\`

直接返回完整的SVG代码，无需其他说明。`,
                    variables: [],
                    source: 'preset',
                    author: 'system'
                },
                
                'preset-book-artistic': {
                    name: '📚 读书笔记卡片（艺术版）',
                    type: 'book',
                    dimensions: '400x533',
                    style: 'artistic',
                    prompt: `你是一位经验丰富的UI设计师，擅长有艺术感的读书笔记卡片设计，并按照SVG图片绘制。

## 任务要求
1. 根据指定的书名，获取书的作者，简介，内容总结，并摘录书中的精美句子
2. 将获取的内容进行可视化，以SVG图片的形式输出
3. SVG图片的背景请按照指定的背景进行绘制，营造纸张质感
4. 请将文本内容换成摘录的书籍内容，可以适当修改样式以适应文本内容

## SVG模板结构
- **画布尺寸**: 400px × 533px
- **配色方案**: 温暖的纸张色调 (#f5f2e9, #c4dccd)
- **字体**: 优雅的中文字体搭配
- **布局**: 层次分明的信息结构

## 设计元素
- 纸张质感背景
- 随机纤维装饰
- 优雅的文字排版
- 艺术感的视觉效果

## SVG代码模板
\`\`\`xml
<svg width="400" height="533" viewBox="0 0 400 533" xmlns="http://www.w3.org/2000/svg">
  <!-- 定义渐变和纹理 -->
  <defs>
    <!-- 纸张渐变 -->
    <linearGradient id="paperGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#f5f2e9"/>
      <stop offset="40%" stop-color="#c4dccd"/>
      <stop offset="100%" stop-color="#f5f2e9"/>
    </linearGradient>
    
    <!-- 纸张纹理滤镜 -->
    <filter id="paperTexture">
      <feTurbulence baseFrequency="0.08" numOctaves="6" seed="5" stitchTiles="stitch"/>
      <feColorMatrix type="saturate" values="0"/>
    </filter>
  </defs>
  
  <!-- 背景 -->
  <rect width="400" height="533" fill="url(#paperGradient)" filter="url(#paperTexture)" opacity="0.3"/>
  <rect width="400" height="533" fill="url(#paperGradient)"/>
  
  <!-- 装饰纤维 -->
  <g opacity="0.03" stroke="#3c3c3c" stroke-width="0.3" fill="none">
    <path d="M100,80 Q120,85 105,90"/>
    <path d="M200,130 Q220,135 205,145"/>
    <path d="M300,180 Q320,190 305,200"/>
    <path d="M150,250 Q160,260 145,270"/>
  </g>
  
  <!-- 主要内容区域 -->
  <!-- 英文引言 -->
  <text x="200" y="100" text-anchor="middle" fill="#3c3c3c" font-size="20" font-family="Huiwen-MinchoGBK, SimSun, serif" font-weight="500">
    <tspan x="200" dy="0">[英文名言第一行]</tspan>
    <tspan x="200" dy="30">[英文名言第二行]</tspan>
    <tspan x="200" dy="30">[英文名言第三行]</tspan>
  </text>
  
  <!-- 中文引言 -->
  <text x="200" y="260" text-anchor="middle" fill="#3c3c3c" font-size="24" font-family="Huiwen-MinchoGBK, SimSun, serif" font-weight="500">
    <tspan x="200" dy="0">[中文名言第一行]</tspan>
    <tspan x="200" dy="35">[中文名言第二行]</tspan>
    <tspan x="200" dy="35">[中文名言第三行]</tspan>
  </text>
  
  <!-- 感悟文字 -->
  <text x="200" y="390" text-anchor="middle" fill="#5a5a5a" font-size="16" font-family="Huiwen-MinchoGBK, SimSun, serif" font-weight="400">
    <tspan x="200" dy="0">[个人感悟第一行]</tspan>
    <tspan x="200" dy="25">[个人感悟第二行]</tspan>
    <tspan x="200" dy="25">[个人感悟第三行]</tspan>
    <tspan x="200" dy="25">[个人感悟第四行]</tspan>
  </text>
  
  <!-- 签名 -->
  <text x="200" y="490" text-anchor="middle" fill="#5a5a5a" font-size="16" font-family="Huiwen-MinchoGBK, SimSun, serif" font-weight="200">
    @读书笔记
  </text>
</svg>
\`\`\`

直接返回完整的SVG代码，无需其他说明。`,
                    variables: [],
                    source: 'preset',
                    author: 'system'
                }
            };
        }


        // 全局变量用于跟踪当前是否使用自定义模板
        let isCustomTemplate = false;
        let basePrompt = '';
        let appliedMainContent = ''; // 记住已应用的主体内容

        // 参数变化时的处理函数
        function onParameterChange() {
            // 如果当前不是自定义模板状态，则更新模板
            if (!isCustomTemplate) {
                updatePromptTemplate();
                // 如果之前有应用过主体内容，重新应用
                if (appliedMainContent) {
                    reapplyMainContent();
                }
            } else {
                // 如果是自定义模板状态，给出提示
                showStatus('当前使用自定义模板，参数选择不会影响提示词', 'warning');
            }
        }

        // 更新提示词模板
        function updatePromptTemplate() {
            const cardType = document.getElementById('cardType').value;
            const dimensions = document.getElementById('dimensions').value;
            const style = document.getElementById('styleTheme').value;
            
            const templateKey = `${cardType}-${dimensions}-${style}`;
            const template = templates[templateKey];
            
            if (template) {
                basePrompt = template.prompt;
                currentPrompt = basePrompt;
                isCustomTemplate = false;
            } else {
                basePrompt = generateDefaultPrompt(cardType, dimensions, style);
                currentPrompt = basePrompt;
                isCustomTemplate = false;
            }
            
            document.getElementById('promptDisplay').textContent = currentPrompt;
            document.getElementById('promptEditor').value = currentPrompt;
        }

        // 应用主体内容
        function applyMainContent() {
            const mainContent = document.getElementById('mainContent').value.trim();
            
            if (!mainContent) {
                showStatus('请输入主体内容', 'error');
                return;
            }
            
            if (!basePrompt) {
                showStatus('请先选择模板或编辑提示词', 'error');
                return;
            }
            
            // 记住应用的主体内容
            appliedMainContent = mainContent;
            
            if (isCustomTemplate) {
                // 对于自定义模板，在末尾添加主体内容指令
                currentPrompt = basePrompt + `\n\n请就主体内容"${mainContent}"为我制作卡片。`;
            } else {
                // 对于默认模板，在开头添加主体内容指令
                currentPrompt = `请就主体内容"${mainContent}"为我制作卡片。\n\n` + basePrompt;
            }
            
            document.getElementById('promptDisplay').textContent = currentPrompt;
            document.getElementById('promptEditor').value = currentPrompt;
            
            // 启用生成按钮
            document.getElementById('generateBtn').disabled = false;
            
            showStatus('主体内容已应用到提示词', 'success');
        }

        // 重新应用主体内容（当参数变化时调用）
        function reapplyMainContent() {
            if (!appliedMainContent) return;
            
            if (isCustomTemplate) {
                // 对于自定义模板，在末尾添加主体内容指令
                currentPrompt = basePrompt + `\n\n请就主体内容"${appliedMainContent}"为我制作卡片。`;
            } else {
                // 对于默认模板，在开头添加主体内容指令
                currentPrompt = `请就主体内容"${appliedMainContent}"为我制作卡片。\n\n` + basePrompt;
            }
            
            document.getElementById('promptDisplay').textContent = currentPrompt;
            document.getElementById('promptEditor').value = currentPrompt;
            
            // 保持生成按钮启用状态
            document.getElementById('generateBtn').disabled = false;
        }

        // 生成默认提示词
        function generateDefaultPrompt(cardType, dimensions, style) {
            const styleMap = {
                'fresh': '清新自然，绿色系配色',
                'business': '商务专业，蓝灰色系',
                'warm': '温暖文艺，橙黄色系',
                'tech': '现代科技，蓝紫色系'
            };
            
            const typeMap = {
                'word': '英语单词学习卡片',
                'book': '读书笔记卡片',
                'movie': '电影收藏卡片',
                'custom': '自定义卡片'
            };
            
            return `请制作一张${typeMap[cardType]}，要求：

## 卡片规格
- 尺寸：${dimensions}px
- 风格：${styleMap[style]}
- 格式：完整的SVG代码

## 设计要求
- 根据内容选择合适的配色方案
- 布局清晰，层次分明
- 适当的装饰元素
- 确保所有文字清晰可读

直接返回完整的SVG代码，无需其他说明。`;
        }

        // 加载自定义模板
        function loadCustomTemplates() {
            const saved = localStorage.getItem('aiCardMaker_customTemplates');
            if (saved) {
                try {
                    const customTemplates = JSON.parse(saved);
                    // 合并自定义模板到templates对象
                    Object.assign(templates, customTemplates);
                } catch (error) {
                    console.error('加载自定义模板失败:', error);
                }
            }
        }


        // 保存自定义模板
        function saveCustomTemplates() {
            const customTemplates = {};
            for (const [key, template] of Object.entries(templates)) {
                if (template.author === 'user') {
                    customTemplates[key] = template;
                }
            }
            localStorage.setItem('aiCardMaker_customTemplates', JSON.stringify(customTemplates));
        }

        // 更新自定义模板列表
        function updateCustomTemplateList() {
            const templateList = document.getElementById('customTemplateList');
            templateList.innerHTML = '';
            
            // 获取用户自定义模板和预设模板
            const customTemplates = Object.entries(templates).filter(([key, template]) => 
                template.author === 'user' || template.source === 'preset'
            );
            
            if (customTemplates.length === 0) {
                templateList.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">暂无自定义模板</div>';
                return;
            }
            
            customTemplates.forEach(([key, template]) => {
                const templateItem = document.createElement('div');
                templateItem.className = 'template-item';
                
                // 预设模板不显示删除按钮
                const isPresetTemplate = template.source === 'preset';
                const deleteButton = isPresetTemplate ? '' : 
                    `<button class="delete-btn" onclick="deleteCustomTemplate('${key}')">删除</button>`;
                
                templateItem.innerHTML = `
                    <div class="template-name" onclick="loadCustomTemplate('${key}')">${template.name}</div>
                    <div class="template-actions">
                        <button class="load-btn" onclick="loadCustomTemplate('${key}')">加载</button>
                        ${deleteButton}
                    </div>
                `;
                templateList.appendChild(templateItem);
            });
        }

        // 加载自定义模板
        function loadCustomTemplate(templateKey) {
            const template = templates[templateKey];
            if (template) {
                // 调试信息
                console.log('加载自定义模板:');
                console.log('template.name:', template.name);
                console.log('template.prompt:', template.prompt);
                
                // 不更新参数选择器，保持自定义模板的独立性
                basePrompt = template.prompt;
                currentPrompt = basePrompt;
                isCustomTemplate = true;
                
                document.getElementById('promptDisplay').textContent = currentPrompt;
                document.getElementById('promptEditor').value = currentPrompt;
                showStatus(`已加载自定义模板: ${template.name}`, 'success');
                
                // 调试信息
                console.log('加载后的状态:');
                console.log('isCustomTemplate:', isCustomTemplate);
                console.log('basePrompt:', basePrompt);
                console.log('currentPrompt:', currentPrompt);
            }
        }

        // 删除自定义模板
        function deleteCustomTemplate(templateKey) {
            if (confirm('确定要删除这个自定义模板吗？')) {
                delete templates[templateKey];
                saveCustomTemplates();
                updateCustomTemplateList();
                showStatus('模板已删除', 'success');
            }
        }

        // 保存当前配置为模板
        function saveCurrentAsTemplate() {
            const templateName = prompt('请输入模板名称：');
            if (!templateName || !templateName.trim()) return;
            
            if (!basePrompt) {
                showStatus('请先选择参数或编辑提示词', 'error');
                return;
            }
            
            // 调试信息
            console.log('保存模板时的状态:');
            console.log('isCustomTemplate:', isCustomTemplate);
            console.log('basePrompt:', basePrompt);
            console.log('currentPrompt:', currentPrompt);
            
            const templateKey = `custom_${Date.now()}`;
            templates[templateKey] = {
                name: templateName.trim(),
                type: 'custom',
                dimensions: 'custom',
                style: 'custom',
                prompt: basePrompt, // 保存基础提示词，不包含主体内容
                variables: [],
                created: new Date().toISOString(),
                author: 'user'
            };
            
            saveCustomTemplates();
            updateCustomTemplateList();
            showStatus(`模板 "${templateName}" 已保存`, 'success');
        }


        // 生成卡片
        async function generateCard() {
            const apiKey = userSettings.apiKey;
            if (!apiKey) {
                showStatus('请先配置 API Key', 'error');
                return;
            }

            if (!currentPrompt) {
                showStatus('请先选择参数并应用主体内容', 'error');
                return;
            }

            const finalPrompt = currentPrompt;
            
            console.log('发送给API的提示词:', finalPrompt);
            
            showStatus('正在生成卡片...', 'warning');
            document.getElementById('previewArea').classList.add('loading');

            try {
                const response = await fetchWithTimeout('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: '你是一个专业的SVG卡片设计师，能够根据要求生成高质量的SVG代码。'
                            },
                            {
                                role: 'user',
                                content: finalPrompt
                            }
                        ],
                        max_tokens: 4000,
                        temperature: 0.7
                    })
                }, 120000); // 120秒超时（2分钟）

                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status}`);
                }

                const data = await response.json();
                const svgCode = extractSVGCode(data.choices[0].message.content);
                
                if (svgCode) {
                    currentSVG = svgCode;
                    displaySVG(svgCode);
                    showStatus('卡片生成成功！', 'success');
                } else {
                    showStatus('未能从响应中提取SVG代码', 'error');
                }

            } catch (error) {
                showStatus(`生成失败：${error.message}`, 'error');
            } finally {
                document.getElementById('previewArea').classList.remove('loading');
            }
        }


        // 提取SVG代码
        function extractSVGCode(content) {
            const svgMatch = content.match(/<svg[\s\S]*?<\/svg>/i);
            return svgMatch ? svgMatch[0] : null;
        }

        // 显示SVG
        function displaySVG(svgCode) {
            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = svgCode;
            previewArea.classList.add('has-content');
            
            // 启用下载按钮
            document.getElementById('downloadSVGBtn').disabled = false;
            document.getElementById('downloadPNGBtn').disabled = false;
            document.getElementById('copyBtn').disabled = false;
        }

        // 下载SVG
        function downloadSVG() {
            if (!currentSVG) return;
            
            const fileName = generateSafeFileName(appliedMainContent);
            const blob = new Blob([currentSVG], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}.svg`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 生成安全的文件名
        function generateSafeFileName(content) {
            if (!content || content.trim() === '') {
                return 'card';
            }
            
            // 移除特殊字符，只保留中文、英文、数字和少数安全字符
            const safeName = content.trim()
                .replace(/[<>:"/\\|?*\x00-\x1f]/g, '') // 移除Windows不支持的字符
                .replace(/\s+/g, '_') // 将空格替换为下划线
                .substring(0, 50); // 限制长度
            
            return safeName || 'card';
        }
        
        // 从SVG中提取原始尺寸
        function getSVGDimensions(svgCode) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(svgCode, 'image/svg+xml');
            const svg = doc.querySelector('svg');
            
            if (!svg) return { width: 400, height: 400 };
            
            // 尝试从width和height属性获取
            let width = svg.getAttribute('width');
            let height = svg.getAttribute('height');
            
            if (width && height) {
                // 移除单位，获取数值
                width = parseInt(width.replace(/[^\d]/g, '')) || 400;
                height = parseInt(height.replace(/[^\d]/g, '')) || 400;
                return { width, height };
            }
            
            // 尝试从viewBox获取
            const viewBox = svg.getAttribute('viewBox');
            if (viewBox) {
                const values = viewBox.split(' ').map(v => parseFloat(v));
                if (values.length === 4) {
                    return { width: values[2], height: values[3] };
                }
            }
            
            // 默认尺寸
            return { width: 400, height: 400 };
        }
        
        // 显示PNG选项
        function showPNGOptions() {
            if (!currentSVG) return;
            document.getElementById('pngOptionsModal').style.display = 'flex';
        }

        // 关闭PNG选项
        function closePNGOptions() {
            document.getElementById('pngOptionsModal').style.display = 'none';
        }

        // 使用选项下载PNG
        function downloadPNGWithOptions() {
            if (!currentSVG) return;
            
            // 使用SVG原始尺寸，而不是卡片尺寸参数
            const svgDimensions = getSVGDimensions(currentSVG);
            const width = svgDimensions.width;
            const height = svgDimensions.height;
            const scale = parseInt(document.getElementById('pngScale').value);
            const background = document.getElementById('pngBackground').value;
            
            convertSVGToPNG(currentSVG, width, height, scale, background).then(blob => {
                if (blob) {
                    const fileName = generateSafeFileName(appliedMainContent);
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${fileName}_${scale}x.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showStatus('PNG 下载成功', 'success');
                    closePNGOptions();
                } else {
                    showStatus('PNG 转换失败', 'error');
                }
            }).catch(error => {
                showStatus('PNG 转换失败: ' + error.message, 'error');
            });
        }

        // SVG转PNG核心函数
        function convertSVGToPNG(svgCode, width, height, scale = 2, background = 'transparent') {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = width * scale;
                canvas.height = height * scale;

                // 设置背景色
                if (background !== 'transparent') {
                    ctx.fillStyle = background;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }

                const img = new Image();
                
                img.onload = () => {
                    try {
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('转换失败'));
                            }
                        }, 'image/png');
                    } catch (error) {
                        reject(error);
                    }
                };

                img.onerror = () => reject(new Error('图片加载失败'));
                
                const svgBlob = new Blob([svgCode], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(svgBlob);
                img.src = url;
            });
        }

        // 复制到剪贴板
        function copyToClipboard() {
            if (!currentSVG) return;
            
            navigator.clipboard.writeText(currentSVG).then(() => {
                showStatus('SVG代码已复制到剪贴板', 'success');
            }).catch(() => {
                showStatus('复制失败', 'error');
            });
        }

        // 切换高级模式
        function toggleAdvancedMode() {
            const advancedMode = document.getElementById('advancedMode');
            advancedMode.classList.toggle('show');
        }

        // 应用自定义提示词
        function applyCustomPrompt() {
            const customPrompt = document.getElementById('promptEditor').value;
            currentPrompt = customPrompt;
            basePrompt = customPrompt; // 同时更新basePrompt，这样保存模板时会保存正确的内容
            isCustomTemplate = true; // 标记为自定义模板状态
            document.getElementById('promptDisplay').textContent = customPrompt;
            showStatus('自定义提示词已应用', 'success');
        }

        // 重置为默认模板
        function resetToDefaultTemplate() {
            isCustomTemplate = false;
            updatePromptTemplate();
            showStatus('已重置为默认模板模式', 'success');
        }


        // 导出模板
        function exportTemplate() {
            const dataStr = JSON.stringify(templates, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'card-templates.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // 显示状态
        function showStatus(message, type) {
            const statusBar = document.getElementById('statusBar');
            const statusText = document.getElementById('statusText');
            
            statusText.textContent = message;
            statusBar.className = `status-bar show ${type}`;
            
            if (type === 'success') {
                setTimeout(() => {
                    statusBar.classList.remove('show');
                }, 3000);
            }
        }

        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'g') {
                e.preventDefault();
                generateCard();
            } else if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (currentSVG) {
                    downloadSVG();
                }
            } else if (e.key === 'Escape') {
                closePNGOptions();
            }
        });

        // 点击弹窗外部关闭
        document.addEventListener('click', function(e) {
            if (e.target.id === 'pngOptionsModal') {
                closePNGOptions();
            }
        });
    </script>
</body>
</html>